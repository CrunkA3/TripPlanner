@page "/Account/Register"
@using Microsoft.AspNetCore.Identity
@using TripPlanner.Web.Models
@inject UserManager<User> UserManager
@inject SignInManager<User> SignInManager
@inject NavigationManager NavigationManager

<PageTitle>Register</PageTitle>

<div style="max-width: 400px; margin: 50px auto;">
    <FluentCard>
        <h2>Register</h2>
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Error">
                @errorMessage
            </FluentMessageBar>
        }

        <EditForm Model="@registerModel" OnValidSubmit="@HandleRegister">
            <DataAnnotationsValidator />
            
            <FluentStack Orientation="Orientation.Vertical" Style="margin-top: 20px;">
                <FluentTextField 
                    @bind-Value="registerModel.Email" 
                    Label="Email"
                    Required="true"
                    Style="width: 100%;" />
                
                <FluentTextField 
                    @bind-Value="registerModel.FirstName" 
                    Label="First Name"
                    Style="width: 100%;" />
                
                <FluentTextField 
                    @bind-Value="registerModel.LastName" 
                    Label="Last Name"
                    Style="width: 100%;" />
                
                <FluentTextField 
                    @bind-Value="registerModel.Password" 
                    Label="Password"
                    TextFieldType="TextFieldType.Password"
                    Required="true"
                    Style="width: 100%;" />
                
                <FluentTextField 
                    @bind-Value="registerModel.ConfirmPassword" 
                    Label="Confirm Password"
                    TextFieldType="TextFieldType.Password"
                    Required="true"
                    Style="width: 100%;" />
                
                <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%;">
                    Register
                </FluentButton>
            </FluentStack>
        </EditForm>
        
        <FluentDivider Style="margin: 20px 0;" />
        
        <div style="text-align: center;">
            <span>Already have an account? </span>
            <FluentAnchor Href="/Account/Login">Login</FluentAnchor>
        </div>
    </FluentCard>
</div>

@code {
    private RegisterModel registerModel = new();
    private string? errorMessage;

    private async Task HandleRegister()
    {
        errorMessage = null;
        
        if (registerModel.Password != registerModel.ConfirmPassword)
        {
            errorMessage = "Passwords do not match.";
            return;
        }

        var user = new User
        {
            UserName = registerModel.Email,
            Email = registerModel.Email,
            FirstName = registerModel.FirstName,
            LastName = registerModel.LastName
        };

        var result = await UserManager.CreateAsync(user, registerModel.Password);

        if (result.Succeeded)
        {
            await SignInManager.SignInAsync(user, isPersistent: false);
            NavigationManager.NavigateTo("/");
        }
        else
        {
            errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
        }
    }

    public class RegisterModel
    {
        public string Email { get; set; } = string.Empty;
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
