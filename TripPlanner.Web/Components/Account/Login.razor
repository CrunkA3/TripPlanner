@page "/Account/Login"
@using Microsoft.AspNetCore.Identity
@using TripPlanner.Web.Models
@inject SignInManager<User> SignInManager
@inject NavigationManager NavigationManager

<PageTitle>Login</PageTitle>

<div style="max-width: 400px; margin: 50px auto;">
    <FluentCard>
        <h2>Login</h2>
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Error">
                @errorMessage
            </FluentMessageBar>
        }

        <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
            <DataAnnotationsValidator />
            
            <FluentStack Orientation="Orientation.Vertical" Style="margin-top: 20px;">
                <FluentTextField 
                    @bind-Value="loginModel.Email" 
                    Label="Email"
                    Required="true"
                    Style="width: 100%;" />
                
                <FluentTextField 
                    @bind-Value="loginModel.Password" 
                    Label="Password"
                    TextFieldType="TextFieldType.Password"
                    Required="true"
                    Style="width: 100%;" />
                
                <FluentCheckbox @bind-Value="loginModel.RememberMe" Label="Remember me" />
                
                <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%;">
                    Login
                </FluentButton>
            </FluentStack>
        </EditForm>
        
        <FluentDivider Style="margin: 20px 0;" />
        
        <div style="text-align: center;">
            <span>Don't have an account? </span>
            <FluentAnchor Href="/Account/Register">Register</FluentAnchor>
        </div>
    </FluentCard>
</div>

@code {
    private LoginModel loginModel = new();
    private string? errorMessage;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private async Task HandleLogin()
    {
        errorMessage = null;
        
        var result = await SignInManager.PasswordSignInAsync(
            loginModel.Email, 
            loginModel.Password, 
            loginModel.RememberMe, 
            lockoutOnFailure: false);

        if (result.Succeeded)
        {
            NavigationManager.NavigateTo(ReturnUrl ?? "/");
        }
        else
        {
            errorMessage = "Invalid login attempt.";
        }
    }

    public class LoginModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public bool RememberMe { get; set; }
    }
}
