@page "/map"

@using TripPlanner.Web.Models
@using TripPlanner.Web.Repositories
@using TripPlanner.Web.Services
@using Microsoft.JSInterop

@inject IPlaceRepository PlaceRepository
@inject ITripRepository TripRepository
@inject IGpxRepository GpxRepository
@inject IJSRuntime JSRuntime
@inject UserService UserService

@implements IAsyncDisposable

@rendermode InteractiveServer

<PageTitle>Map View</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Width="100%" Style="height: calc(100vh - 200px);">
    <FluentToolbar>
        <FluentLabel Typo="Typography.H3">
            <FluentIcon Value="@(new Icons.Regular.Size24.Map())" Color="Color.Accent" />
            Map View
        </FluentLabel>
        <FluentSpacer />
        <FluentSelect TOption="string" @bind-Value="@SelectedTripId" Label="Select Trip" Style="min-width: 200px;">
            <FluentOption TOption="string" Value="@string.Empty">All Places</FluentOption>
            @foreach (var trip in Trips)
            {
                <FluentOption TOption="string" Value="@trip.Id">@trip.Name</FluentOption>
            }
        </FluentSelect>
        <FluentButton Appearance="Appearance.Lightweight" OnClick="@LoadMapData">
            <FluentIcon Value="@(new Icons.Regular.Size20.ArrowSync())" />
            Refresh
        </FluentButton>
    </FluentToolbar>

    <FluentCard Style="flex: 1; display: flex; flex-direction: column;">
        <FluentStack Orientation="Orientation.Horizontal" Style="height: 100%;">
            <!-- Map Container -->
            <div id="map-container" style="flex: 1; min-height: 500px; background: var(--neutral-layer-2); border-radius: 4px; height: 100%">
                <div id="map" style="width: 100%; height: 100%; min-height: 500px;"></div>
            </div>

            <!-- Side Panel -->
            <FluentStack Orientation="Orientation.Vertical" Style="width: 300px; max-height: 100%; overflow-y: auto; padding-left: 16px;">
                <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">Places on Map</FluentLabel>

                @if (CurrentUser?.HomeLatitude.HasValue == true && CurrentUser?.HomeLongitude.HasValue == true)
                {
                    <FluentCard Style="border-left: 4px solid #1A73E8;">
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                                <FluentIcon Value="@(new Icons.Regular.Size16.Home())" Color="Color.Accent" />
                                <FluentLabel Weight="FontWeight.Bold">@(CurrentUser.HomeLocationName ?? "Home")</FluentLabel>
                            </FluentStack>
                            <FluentLabel Style="font-size: 0.875em;">
                                @CurrentUser.HomeLatitude.Value.ToString("F4"), @CurrentUser.HomeLongitude.Value.ToString("F4")
                            </FluentLabel>
                        </FluentStack>
                    </FluentCard>
                }
                
                @if (IsLoading)
                {
                    <FluentProgressRing />
                }
                else if (!Places.Any() && !SelectedTripPlaces.Any())
                {
                    <FluentLabel Style="font-size: 0.875em;">No places to display</FluentLabel>
                }
                else
                {
                    <FluentAccordion>
                        @if (Places.Any())
                        {
                            <FluentAccordionItem Heading="Wishlist Places" Expanded="true">
                                <FluentStack Orientation="Orientation.Vertical">
                                    @foreach (var place in Places)
                                    {
                                        <FluentCard>
                                            <FluentStack Orientation="Orientation.Vertical">
                                                <FluentLabel Weight="FontWeight.Bold">@place.Name</FluentLabel>
                                                <FluentBadge BackgroundColor="var(--neutral-layer-3)">@place.Category</FluentBadge>
                                                <FluentLabel Style="font-size: 0.875em;">
                                                    @place.Latitude.ToString("F4"), @place.Longitude.ToString("F4")
                                                </FluentLabel>
                                            </FluentStack>
                                        </FluentCard>
                                    }
                                </FluentStack>
                            </FluentAccordionItem>
                        }
                        
                        @if (SelectedTripPlaces.Any())
                        {
                            <FluentAccordionItem Heading="Trip Places" Expanded="true">
                                <FluentStack Orientation="Orientation.Vertical">
                                    @foreach (var tripPlace in SelectedTripPlaces)
                                    {
                                        @if (tripPlace.Place != null)
                                        {
                                            <FluentCard>
                                                <FluentStack Orientation="Orientation.Vertical">
                                                    <FluentLabel Weight="FontWeight.Bold">@tripPlace.Place.Name</FluentLabel>
                                                    @if (tripPlace.ScheduledTime.HasValue)
                                                    {
                                                        <FluentLabel Style="font-size: 0.875em;">
                                                            <FluentIcon Value="@(new Icons.Regular.Size12.Clock())" />
                                                            @tripPlace.ScheduledTime.Value.ToString("HH:mm")
                                                        </FluentLabel>
                                                    }
                                                    <FluentLabel Style="font-size: 0.875em;">
                                                        @tripPlace.Place.Latitude.ToString("F4"), @tripPlace.Place.Longitude.ToString("F4")
                                                    </FluentLabel>
                                                </FluentStack>
                                            </FluentCard>
                                        }
                                    }
                                </FluentStack>
                            </FluentAccordionItem>
                        }
                    </FluentAccordion>
                }
                
                <FluentDivider />
                
                <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">Map Features</FluentLabel>
                <FluentStack Orientation="Orientation.Vertical">
                    <FluentCheckbox Label="Show Wishlist Places" @bind-Value="@ShowWishlist" />
                    <FluentCheckbox Label="Show Trip Routes" @bind-Value="@ShowRoutes" />
                    <FluentCheckbox Label="Show GPX Tracks" @bind-Value="@ShowGpxTracks" />
                </FluentStack>
                
                <FluentLabel Style="font-size: 0.875em; margin-top: 16px;">
                    Interactive map powered by MapLibre GL JS and OpenStreetMap.
                </FluentLabel>
            </FluentStack>
        </FluentStack>
    </FluentCard>
</FluentStack>

@code {
    private List<Place> Places { get; set; } = new();
    private List<Trip> Trips { get; set; } = new();
    private List<GpxTrack> GpxTracks { get; set; } = new();
    private List<TripPlace> SelectedTripPlaces { get; set; } = new();
    private string SelectedTripId { get; set; } = string.Empty;
    private bool IsLoading { get; set; } = true;
    private bool ShowWishlist { get; set; } = true;
    private bool ShowRoutes { get; set; } = true;
    private bool ShowGpxTracks { get; set; } = true;
    private bool MapInitialized { get; set; }
    private ApplicationUser? CurrentUser { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadMapData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeMap();
            await UpdateMapContent();
        }
    }

    private async Task InitializeMap()
    {
        try
        {
            double centerLat = 48.8566, centerLng = 2.3522;
            int zoom = 6;
            if (CurrentUser?.HomeLatitude.HasValue == true && CurrentUser?.HomeLongitude.HasValue == true)
            {
                centerLat = CurrentUser.HomeLatitude.Value;
                centerLng = CurrentUser.HomeLongitude.Value;
                zoom = 10;
            }
            await JSRuntime.InvokeVoidAsync("mapInterop.initializeMap", "map", centerLat, centerLng, zoom);
            MapInitialized = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing map: {ex.Message}");
        }
    }

    private async Task LoadMapData()
    {
        IsLoading = true;
        
        CurrentUser = await UserService.GetCurrentUserAsync();
        Places = await PlaceRepository.GetAllAsync();
        Trips = await TripRepository.GetAllAsync();
        GpxTracks = await GpxRepository.GetAllAsync();
        
        if (!string.IsNullOrEmpty(SelectedTripId))
        {
            var selectedTrip = Trips.FirstOrDefault(t => t.Id == SelectedTripId);
            if (selectedTrip != null)
            {
                SelectedTripPlaces = selectedTrip.Days
                    .SelectMany(d => d.Places)
                    .ToList();
                
                // Load place details
                foreach (var tripPlace in SelectedTripPlaces)
                {
                    tripPlace.Place = Places.FirstOrDefault(p => p.Id == tripPlace.PlaceId);
                }
            }
        }
        else
        {
            SelectedTripPlaces.Clear();
        }
        
        IsLoading = false;

        if (MapInitialized)
        {
            await UpdateMapContent();
        }
    }

    private async Task UpdateMapContent()
    {
        if (!MapInitialized) return;

        try
        {
            // Clear existing map content
            await JSRuntime.InvokeVoidAsync("mapInterop.clearMarkers");
            await JSRuntime.InvokeVoidAsync("mapInterop.clearRoutes");
            await JSRuntime.InvokeVoidAsync("mapInterop.clearGpxTracks");

            // Add home location marker
            if (CurrentUser?.HomeLatitude.HasValue == true && CurrentUser?.HomeLongitude.HasValue == true)
            {
                await JSRuntime.InvokeVoidAsync("mapInterop.addHomeMarker",
                    CurrentUser.HomeLatitude.Value, CurrentUser.HomeLongitude.Value,
                    CurrentUser.HomeLocationName ?? "Home");
            }

            // Add markers for wishlist places
            if (ShowWishlist)
            {
                foreach (var place in Places)
                {
                    var color = GetCategoryColor(place.Category);
                    await JSRuntime.InvokeVoidAsync("mapInterop.addMarker",
                        place.Id, place.Latitude, place.Longitude,
                        place.Name, place.Category.ToString(), color);
                }
            }

            // Add routes and markers for selected trip
            if (!string.IsNullOrEmpty(SelectedTripId) && ShowRoutes)
            {
                var selectedTrip = Trips.FirstOrDefault(t => t.Id == SelectedTripId);
                if (selectedTrip != null)
                {
                    foreach (var day in selectedTrip.Days.OrderBy(d => d.DayNumber))
                    {
                        var dayPlaces = day.Places.OrderBy(p => p.Order).ToList();
                        if (dayPlaces.Count > 1)
                        {
                            var coordinates = dayPlaces
                                .Where(tp => tp.Place != null)
                                .Select(tp => new { latitude = tp.Place!.Latitude, longitude = tp.Place.Longitude })
                                .ToList();
                            
                            if (coordinates.Any())
                            {
                                await JSRuntime.InvokeVoidAsync("mapInterop.addRoute", coordinates, "#FF5722", 3);
                            }
                        }
                    }
                }
            }

            // Add GPX tracks
            if (ShowGpxTracks)
            {
                foreach (var gpxTrack in GpxTracks)
                {
                    if (gpxTrack.Points.Any())
                    {
                        var points = gpxTrack.Points.Select(p => new { latitude = p.Latitude, longitude = p.Longitude }).ToList();
                        await JSRuntime.InvokeVoidAsync("mapInterop.addGpxTrack", points, "#9C27B0");
                    }
                }
            }

            // Fit map to show all content
            await JSRuntime.InvokeVoidAsync("mapInterop.fitBounds");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating map content: {ex.Message}");
        }
    }

    private string GetCategoryColor(PlaceCategory category)
    {
        return category switch
        {
            PlaceCategory.Viewpoint => "#4285F4",
            PlaceCategory.Museum => "#EA4335",
            PlaceCategory.Restaurant => "#FBBC04",
            PlaceCategory.Nature => "#34A853",
            PlaceCategory.Activity => "#00ACC1",
            PlaceCategory.Accommodation => "#9C27B0",
            PlaceCategory.Shopping => "#FF6F00",
            PlaceCategory.Entertainment => "#E91E63",
            _ => "#757575"
        };
    }

    public async ValueTask DisposeAsync()
    {
        if (MapInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("mapInterop.destroyMap");
            }
            catch { }
        }
    }
}
