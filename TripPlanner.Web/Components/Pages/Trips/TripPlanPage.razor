@page "/trips/{tripId}"

@using Microsoft.AspNetCore.Authorization
@using TripPlanner.Web.Models
@using TripPlanner.Web.Repositories
@using TripPlanner.Web.Services

@attribute [Authorize]

@inject ITripRepository TripRepository
@inject IPlaceRepository PlaceRepository
@inject UserService UserService
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

@implements IAsyncDisposable

@rendermode InteractiveServer

<FluentGrid Spacing="3">
    @if (PlanningTrip != null)
    {
        <FluentGridItem xs="12" lg="6" xl="3">
            <FluentGrid>
                <FluentGridItem xs="12" lg="6">
                    <!-- Unscheduled Places -->
                    <FluentCard Style="flex: 0 0 300px; min-height: 500px;">
                        <FluentStack Orientation="Orientation.Horizontal" Style="margin-bottom: 4px;">
                            <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">Available Places</FluentLabel>
                            <FluentSpacer />
                            <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Add())" OnClick="@OpenAddPlaceDialog" Style="padding: 4px 8px; font-size: 0.8em;">
                                New
                            </FluentButton>
                        </FluentStack>
                        <FluentLabel Style="font-size: 0.875em; margin-bottom: 8px;">Drag places to days to schedule them</FluentLabel>

                        <FluentStack Orientation="Orientation.Vertical" Style="gap: 8px;">
                            @foreach (var place in AllPlaces)
                            {
                                var isScheduled = PlanningTrip.Days.Any(d => d.Places.Any(p => p.PlaceId == place.Id));
                                @if (!isScheduled)
                                {
                                    <FluentCard class="draggable"
                                                draggable="true"
                                                @ondragstart="@((e) => HandleDragStart(place.Id, null, -1))"
                                                @ondragend="@HandleDragEnd"
                                                Style="cursor: move; padding: 12px;">
                                        <FluentStack Orientation="Orientation.Vertical">
                                            <FluentLabel Weight="FontWeight.Bold">@place.Name</FluentLabel>
                                            <FluentBadge BackgroundColor="var(--neutral-layer-3)">@place.Category</FluentBadge>
                                            <FluentLabel Style="font-size: 0.875em;">
                                                @place.Latitude.ToString("F2"), @place.Longitude.ToString("F2")
                                            </FluentLabel>
                                        </FluentStack>
                                    </FluentCard>
                                }
                            }
                        </FluentStack>
                    </FluentCard>
                </FluentGridItem>
                <FluentGridItem xs="12" lg="6">
                    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Stretch" VerticalGap="6">

                        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveTripPlan">Save Plan</FluentButton>
                        <!-- Days -->
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="6">
                            @foreach (var day in PlanningTrip.Days.OrderBy(d => d.DayNumber))
                            {
                                <FluentCard class="drop-zone"
                                            @ondragover:preventDefault
                                            @ondragenter="@((e) => HandleDragEnter(day.Id))"
                                            @ondragleave="@((e) => HandleDragLeave())"
                                            @ondrop="@(async (e) => await HandleDrop(day.Id))"
                                            Style="@(CurrentDropTarget == day.Id ? "background-color: var(--neutral-layer-2); border: 2px dashed var(--accent-fill-rest);" : "")">
                                    <FluentStack Orientation="Orientation.Vertical">
                                        <FluentStack Orientation="Orientation.Horizontal">
                                            <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">
                                                Day @day.DayNumber
                                            </FluentLabel>
                                            @if (day.Date.HasValue)
                                            {
                                                <FluentLabel Style="font-size: 0.875em;">
                                                    - @day.Date.Value.ToString("MMM dd, yyyy")
                                                </FluentLabel>
                                            }
                                            <FluentSpacer />
                                            <FluentLabel Style="font-size: 0.875em;">
                                                @day.Places.Count places
                                            </FluentLabel>
                                        </FluentStack>

                                        <FluentDivider />

                                        @if (!day.Places.Any())
                                        {
                                            <FluentLabel Style="font-size: 0.875em; text-align: center; padding: 24px; color: var(--neutral-foreground-hint);">
                                                Drop places here to schedule
                                            </FluentLabel>
                                        }
                                        else
                                        {
                                            <FluentStack Orientation="Orientation.Vertical" Style="gap: 8px;">
                                                @foreach (var tripPlace in day.Places.OrderBy(p => p.Order))
                                                {
                                                    <FluentCard class="draggable"
                                                                draggable="true"
                                                                @ondragstart="@((e) => HandleDragStart(tripPlace.PlaceId, day.Id, tripPlace.Order))"
                                                                @ondragend="@HandleDragEnd"
                                                                Style="cursor: move; padding: 8px;">
                                                        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                                                            <FluentIcon Value="@(new Icons.Regular.Size16.Navigation())" />
                                                            <FluentLabel Weight="FontWeight.Bold">@(tripPlace.Place?.Name ?? "Unknown")</FluentLabel>
                                                            <FluentSpacer />
                                                            <input type="time"
                                                                   value="@(tripPlace.ScheduledTime.HasValue? tripPlace.ScheduledTime.Value.ToString("HH:mm") : "")"
                                                                   @onchange="@((e) => UpdateScheduledTime(tripPlace, e.Value?.ToString(), day.Date))"
                                                                   style="border: 1px solid var(--neutral-stroke-rest); border-radius: 4px; padding: 2px 4px; font-size: 0.875em; background: transparent;" />
                                                            <FluentButton Appearance="Appearance.Lightweight"
                                                                          OnClick="@(async () => await RemovePlaceFromDay(day.Id, tripPlace.PlaceId))"
                                                                          Style="padding: 4px;">
                                                                <FluentIcon Value="@(new Icons.Regular.Size12.Dismiss())" />
                                                            </FluentButton>
                                                        </FluentStack>
                                                    </FluentCard>
                                                }
                                            </FluentStack>
                                        }
                                    </FluentStack>
                                </FluentCard>
                            }
                        </FluentStack>
                    </FluentStack>
                </FluentGridItem>
                <!-- Accommodations -->
                <FluentGridItem xs="12">
                    <FluentCard Style="min-height: 100px;">
                        <FluentStack Orientation="Orientation.Horizontal" Style="margin-bottom: 8px;">
                            <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">Accommodations</FluentLabel>
                            <FluentSpacer />
                            <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Add())" OnClick="@OpenAddAccommodationDialog" Style="padding: 4px 8px; font-size: 0.8em;">
                                New
                            </FluentButton>
                        </FluentStack>
                        @if (PlanningTrip?.Accommodations.Count == 0)
                        {
                            <FluentLabel Style="font-size: 0.875em; color: var(--neutral-foreground-hint);">No accommodations added yet.</FluentLabel>
                        }
                        else
                        {
                            <FluentStack Orientation="Orientation.Vertical" Style="gap: 8px;">
                                @foreach (var acc in PlanningTrip!.Accommodations.OrderBy(a => a.PlannedCheckIn))
                                {
                                    <FluentCard Style="padding: 10px;">
                                        <FluentStack Orientation="Orientation.Vertical">
                                            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                                                <FluentLabel Weight="FontWeight.Bold">@acc.Name</FluentLabel>
                                                <FluentSpacer />
                                                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => OpenEditAccommodationDialog(acc))" Style="padding: 4px;" title="Edit">
                                                    <FluentIcon Value="@(new Icons.Regular.Size16.Edit())" />
                                                </FluentButton>
                                                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(async () => await DeleteAccommodation(acc.Id))" Style="padding: 4px;" title="Delete">
                                                    <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" />
                                                </FluentButton>
                                            </FluentStack>
                                            @if (!string.IsNullOrEmpty(acc.Address))
                                            {
                                                <FluentLabel Style="font-size: 0.8em;">📍 @acc.Address</FluentLabel>
                                            }
                                            @if (acc.PlannedCheckIn.HasValue)
                                            {
                                                <FluentLabel Style="font-size: 0.8em;">🏨 Check-in: @acc.PlannedCheckIn.Value.ToString("dd.MM.yyyy HH:mm")</FluentLabel>
                                            }
                                            @if (acc.PlannedCheckOut.HasValue)
                                            {
                                                <FluentLabel Style="font-size: 0.8em;">🚪 Check-out: @acc.PlannedCheckOut.Value.ToString("dd.MM.yyyy HH:mm")</FluentLabel>
                                            }
                                            @if (acc.EarliestCheckIn.HasValue || acc.LatestCheckOut.HasValue)
                                            {
                                                <FluentLabel Style="font-size: 0.8em; color: var(--neutral-foreground-hint);">
                                                    Earliest:
                                                    @if (acc.EarliestCheckIn.HasValue)
                                                    {
                                                        <text> Check-in @acc.EarliestCheckIn.Value.ToString("HH:mm")</text>
                                                    }
                                                    @if (acc.LatestCheckOut.HasValue)
                                                    {
                                                        <text> / Latest Check-out @acc.LatestCheckOut.Value.ToString("HH:mm")</text>
                                                    }
                                                </FluentLabel>
                                            }
                                        </FluentStack>
                                    </FluentCard>
                                }
                            </FluentStack>
                        }
                    </FluentCard>
                </FluentGridItem>
            </FluentGrid>
        </FluentGridItem>
    }
    <FluentGridItem xs="12" lg="6" xl="9">
        <!-- Map -->
        <div id="trip-map" style="width: 100%; height: 100%; border-radius: 4px;"></div>
    </FluentGridItem>
</FluentGrid>


<FluentDialog @bind-Hidden="@HideAccommodationDialog" Modal="true" TrapFocus="true">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">@(IsEditingAccommodation ? "Edit Accommodation" : "Add Accommodation")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (EditingAccommodation != null)
        {
            <FluentStack Orientation="Orientation.Vertical">
                <FluentTextField @bind-Value="@EditingAccommodation.Name" Label="Name" Required Style="width: 100%;" />
                <FluentTextField @bind-Value="@EditingAccommodation.Address" Label="Address" Style="width: 100%;" />
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 4px; width: 100%;">
                    <FluentLabel>Planned Check-in</FluentLabel>
                    <input type="datetime-local"
                           value="@_plannedCheckInString"
                           @onchange="@((e) => _plannedCheckInString = e.Value?.ToString() ?? string.Empty)"
                           style="border: 1px solid var(--neutral-stroke-rest); border-radius: 4px; padding: 4px 8px; font-size: 0.875em; background: transparent; width: 100%;" />
                </FluentStack>
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 4px; width: 100%;">
                    <FluentLabel>Planned Check-out</FluentLabel>
                    <input type="datetime-local"
                           value="@_plannedCheckOutString"
                           @onchange="@((e) => _plannedCheckOutString = e.Value?.ToString() ?? string.Empty)"
                           style="border: 1px solid var(--neutral-stroke-rest); border-radius: 4px; padding: 4px 8px; font-size: 0.875em; background: transparent; width: 100%;" />
                </FluentStack>
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 4px; width: 100%;">
                    <FluentLabel>Earliest Check-in Time</FluentLabel>
                    <input type="time"
                           value="@_earliestCheckInString"
                           @onchange="@((e) => _earliestCheckInString = e.Value?.ToString() ?? string.Empty)"
                           style="border: 1px solid var(--neutral-stroke-rest); border-radius: 4px; padding: 4px 8px; font-size: 0.875em; background: transparent; width: 100%;" />
                </FluentStack>
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 4px; width: 100%;">
                    <FluentLabel>Latest Check-out Time</FluentLabel>
                    <input type="time"
                           value="@_latestCheckOutString"
                           @onchange="@((e) => _latestCheckOutString = e.Value?.ToString() ?? string.Empty)"
                           style="border: 1px solid var(--neutral-stroke-rest); border-radius: 4px; padding: 4px 8px; font-size: 0.875em; background: transparent; width: 100%;" />
                </FluentStack>
                <FluentNumberField @bind-Value="@EditingAccommodation.Latitude" Label="Latitude" Step="0.0001" Style="width: 100%;" />
                <FluentNumberField @bind-Value="@EditingAccommodation.Longitude" Label="Longitude" Step="0.0001" Style="width: 100%;" />
                <FluentTextArea @bind-Value="@EditingAccommodation.Notes" Label="Notes" Rows="2" Style="width: 100%;" />
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveAccommodation">Save</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => HideAccommodationDialog = true)">Cancel</FluentButton>
    </FluentDialogFooter>
</FluentDialog>



<FluentDialogProvider />

@code {
    private bool IsLoading { get; set; } = true;
    private bool MapInitialized { get; set; }
    private ApplicationUser? CurrentUser { get; set; }

    [Parameter]
    public string TripId { get; set; } = string.Empty;

    private List<Place> AllPlaces { get; set; } = new();

    private Trip? PlanningTrip;




    // Drag and drop state
    private string? DraggedPlaceId { get; set; }
    private string? DraggedFromDayId { get; set; }
    private int DraggedFromOrder { get; set; }
    private string? CurrentDropTarget { get; set; }


    // Accommodation state
    private bool HideAccommodationDialog { get; set; } = true;
    private Accommodation? EditingAccommodation { get; set; }
    private bool IsEditingAccommodation { get; set; }
    private string _plannedCheckInString = string.Empty;
    private string _plannedCheckOutString = string.Empty;
    private string _earliestCheckInString = string.Empty;
    private string _latestCheckOutString = string.Empty;





    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeMap();
            await UpdateMapContent();
        }
    }

    private async Task InitializeMap()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("mapInterop.initializeMap", "trip-map", 48.8566, 2.3522, 4);
            MapInitialized = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing map: {ex.Message}");
        }
    }

    private async Task UpdateMapContent()
    {
        if (!MapInitialized || PlanningTrip == null) return;

        try
        {
            await JSRuntime.InvokeVoidAsync("mapInterop.clearMarkers");
            await JSRuntime.InvokeVoidAsync("mapInterop.clearRoutes");


            // Add home location marker
            if (CurrentUser?.HomeLatitude.HasValue == true && CurrentUser?.HomeLongitude.HasValue == true)
            {
                await JSRuntime.InvokeVoidAsync("mapInterop.addHomeMarker",
                    CurrentUser.HomeLatitude.Value, CurrentUser.HomeLongitude.Value,
                    CurrentUser.HomeLocationName ?? "Home");
            }


            // Collect all scheduled places in chronological order
            var orderedPlaces = PlanningTrip.Days
                .OrderBy(d => d.DayNumber)
                .SelectMany(d => d.Places.OrderBy(p => p.Order))
                .Where(tp => tp.Place != null)
                .ToList();

            // Add markers for scheduled places
            foreach (var tp in orderedPlaces)
            {
                var color = GetCategoryColor(tp.Place!.Category);
                await JSRuntime.InvokeVoidAsync("mapInterop.addMarker",
                    tp.PlaceId, tp.Place.Latitude, tp.Place.Longitude,
                    tp.Place.Name, tp.Place.Category.ToString(), color);
            }

            // Add markers for unscheduled places (grey)
            foreach (var place in AllPlaces)
            {
                bool isScheduled = PlanningTrip.Days.Any(d => d.Places.Any(p => p.PlaceId == place.Id));
                if (!isScheduled)
                {
                    await JSRuntime.InvokeVoidAsync("mapInterop.addMarker",
                        place.Id, place.Latitude, place.Longitude,
                        place.Name, place.Category.ToString(), "#9E9E9E");
                }
            }



            // Add accommodation markers
            foreach (var acc in PlanningTrip.Accommodations)
            {
                if (acc.Latitude == 0 && acc.Longitude == 0) continue;
                var checkInStr = acc.PlannedCheckIn.HasValue ? acc.PlannedCheckIn.Value.ToString("dd.MM.yyyy HH:mm") : null;
                var checkOutStr = acc.PlannedCheckOut.HasValue ? acc.PlannedCheckOut.Value.ToString("dd.MM.yyyy HH:mm") : null;
                await JSRuntime.InvokeVoidAsync("mapInterop.addAccommodationMarker",
                    acc.Id, acc.Latitude, acc.Longitude, acc.Name, checkInStr, checkOutStr);
            }




            // Draw a line connecting all scheduled places chronologically
            var placesByDay = PlanningTrip.Days
                .OrderBy(d => d.DayNumber)
                .ToList();

            if (placesByDay.Count > 1)
            {
                foreach (var day in placesByDay)
                {
                    if (!day.Date.HasValue) continue;

                    var currentPlaces = day.Places
                        .Where(tp => tp.Place is not null)
                        .Select(tp => (time: tp.ScheduledTime, order: tp.Order, tp.Place!.Latitude, tp.Place!.Longitude))
                        .ToList();

                    var wayPoints = currentPlaces.ToList();
                    if (day.DayNumber == 1 && CurrentUser is not null && CurrentUser.HomeLatitude.HasValue && CurrentUser.HomeLongitude.HasValue)
                    {
                        wayPoints.Add((time: day.Date.Value.Date, order: -2, Latitude: CurrentUser.HomeLatitude.Value, Longitude: CurrentUser.HomeLongitude.Value));
                    }

                    foreach (var acc in PlanningTrip.Accommodations)
                    {
                        if (acc.PlannedCheckIn.HasValue && acc.PlannedCheckOut.HasValue)
                        {
                            var accTimeStart = acc.PlannedCheckIn.Value;
                            var accTimeEnd = acc.PlannedCheckOut.Value;
                            var dayStart = day.Date.Value.Date;
                            var dayEnd = day.Date.Value.Date.AddDays(1).AddTicks(-1);

                            if (accTimeStart <= dayEnd && accTimeEnd >= dayStart)
                            {
                                wayPoints.Add((time: accTimeStart, order: -1, Latitude: acc.Latitude, Longitude: acc.Longitude));
                                wayPoints.Add((time: accTimeEnd, order: 99, Latitude: acc.Latitude, Longitude: acc.Longitude));
                            }
                        }
                    }

                    if (wayPoints.Count > 1)
                    {
                        var coordinates = wayPoints
                            .OrderBy(p => p.time)
                            .ThenBy(p => p.order)
                            .Select(p => new { latitude = p.Latitude, longitude = p.Longitude })
                            .ToList();
                        await JSRuntime.InvokeVoidAsync("mapInterop.addRoute", coordinates, "#FF5722", 3);
                    }

                }
            }

            // if (orderedPlaces.Count > 1)
            // {
            //     var coordinates = orderedPlaces
            //         .Select(tp => new { latitude = tp.Place!.Latitude, longitude = tp.Place.Longitude })
            //         .ToList();
            //     await JSRuntime.InvokeVoidAsync("mapInterop.addRoute", coordinates, "#FF5722", 3);
            // }

            await JSRuntime.InvokeVoidAsync("mapInterop.fitBounds");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating map content: {ex.Message}");
        }
    }

    private string GetCategoryColor(PlaceCategory category)
    {
        return category switch
        {
            PlaceCategory.Viewpoint => "#4285F4",
            PlaceCategory.Museum => "#EA4335",
            PlaceCategory.Restaurant => "#FBBC04",
            PlaceCategory.Nature => "#34A853",
            PlaceCategory.Activity => "#00ACC1",
            PlaceCategory.Accommodation => "#9C27B0",
            PlaceCategory.Shopping => "#FF6F00",
            PlaceCategory.Entertainment => "#E91E63",
            _ => "#757575"
        };
    }

    private async Task LoadData()
    {
        IsLoading = true;

        var currentUserId = await UserService.GetCurrentUserIdAsync();

        PlanningTrip = await TripRepository.GetByIdAsync(TripId);

        
        CurrentUser = await UserService.GetCurrentUserAsync();
        var wishListPlaces = await PlaceRepository.GetAllWithAnyWishlistAsync();
        var tripPlaces = await PlaceRepository.GetAllForTripAsync(TripId);
        AllPlaces = wishListPlaces.UnionBy(tripPlaces, p => p.Id).ToList();

        // Load place details for all trips
        if (PlanningTrip != null)
        {
            foreach (var day in PlanningTrip.Days)
            {
                foreach (var tripPlace in day.Places)
                {
                    tripPlace.Place = AllPlaces.FirstOrDefault(p => p.Id == tripPlace.PlaceId);
                }
            }

            foreach (var tripPlace in PlanningTrip.UnscheduledPlaces)
            {
                tripPlace.Place = AllPlaces.FirstOrDefault(p => p.Id == tripPlace.PlaceId);
            }
        }

        IsLoading = false;
    }




    private async Task RemovePlaceFromDay(string dayId, string placeId)
    {
        if (PlanningTrip == null)
            return;

        var day = PlanningTrip.Days.FirstOrDefault(d => d.Id == dayId);
        if (day != null)
        {
            var placeToRemove = day.Places.FirstOrDefault(p => p.PlaceId == placeId);
            if (placeToRemove != null)
            {
                day.Places.Remove(placeToRemove);
                // Reorder remaining places
                var order = 1;
                foreach (var p in day.Places.OrderBy(p => p.Order))
                {
                    p.Order = order++;
                }
            }
        }
        await UpdateMapContent();
    }

    private async Task SaveTripPlan()
    {
        if (PlanningTrip == null)
            return;

        PlanningTrip.UpdatedAt = DateTime.UtcNow;
        await TripRepository.UpdateAsync(PlanningTrip);

        PlanningTrip = null;
        await LoadData();
        await UpdateMapContent();
    }



    // Drag and drop handlers
    private void HandleDragStart(string placeId, string? fromDayId, int fromOrder)
    {
        DraggedPlaceId = placeId;
        DraggedFromDayId = fromDayId;
        DraggedFromOrder = fromOrder;
    }

    private void HandleDragEnd()
    {
        // Keep the state until drop completes
    }

    private void HandleDragEnter(string dayId)
    {
        CurrentDropTarget = dayId;
    }

    private void HandleDragLeave()
    {
        CurrentDropTarget = null;
    }

    private async Task HandleDrop(string toDayId)
    {
        CurrentDropTarget = null;

        if (PlanningTrip == null || string.IsNullOrEmpty(DraggedPlaceId))
            return;

        var toDay = PlanningTrip.Days.FirstOrDefault(d => d.Id == toDayId);
        if (toDay == null)
            return;

        // Remove from source if it was in a day
        if (!string.IsNullOrEmpty(DraggedFromDayId))
        {
            var fromDay = PlanningTrip.Days.FirstOrDefault(d => d.Id == DraggedFromDayId);
            if (fromDay != null)
            {
                var placeToMove = fromDay.Places.FirstOrDefault(p => p.PlaceId == DraggedPlaceId);
                if (placeToMove != null)
                {
                    fromDay.Places.Remove(placeToMove);
                    // Reorder remaining places
                    var order = 1;
                    foreach (var p in fromDay.Places.OrderBy(p => p.Order))
                    {
                        p.Order = order++;
                    }
                }
            }
        }

        // Add to target day
        var place = AllPlaces.FirstOrDefault(p => p.Id == DraggedPlaceId);
        if (place != null)
        {
            var newOrder = toDay.Places.Any() ? toDay.Places.Max(p => p.Order) + 1 : 1;
            toDay.Places.Add(new TripPlace
            {
                PlaceId = place.Id,
                Order = newOrder,
                Place = place
            });
        }

        // Clear drag state
        DraggedPlaceId = null;
        DraggedFromDayId = null;
        DraggedFromOrder = -1;

        StateHasChanged();
        await UpdateMapContent();
    }

    private void UpdateScheduledTime(TripPlace tripPlace, string? timeString, DateTime? dayDate)
    {
        if (string.IsNullOrEmpty(timeString))
        {
            tripPlace.ScheduledTime = null;
        }
        else if (TimeOnly.TryParse(timeString, out var time))
        {
            var baseDate = dayDate?.Date ?? DateTime.Today;
            tripPlace.ScheduledTime = baseDate.Add(time.ToTimeSpan());
        }
    }

    private async Task OpenAddPlaceDialog()
    {
        var dialog = await DialogService.ShowDialogAsync<TripAddPlaceDialog>(new Place() { TripId = TripId }, new DialogParameters()
        {
            PreventDismissOnOverlayClick = true,
            PreventScroll = true,
            TrapFocus = true
        });

        var result = await dialog.Result;

        if (!result.Cancelled && result.Data is not null)
        {
            AllPlaces.Add((Place)result.Data);
            StateHasChanged();
            await UpdateMapContent();
        }
    }




    private void OpenAddAccommodationDialog()
    {
        EditingAccommodation = new Accommodation { TripId = TripId };
        IsEditingAccommodation = false;
        _plannedCheckInString = string.Empty;
        _plannedCheckOutString = string.Empty;
        _earliestCheckInString = string.Empty;
        _latestCheckOutString = string.Empty;
        HideAccommodationDialog = false;
    }

    private void OpenEditAccommodationDialog(Accommodation acc)
    {
        EditingAccommodation = new Accommodation
        {
            Id = acc.Id,
            TripId = acc.TripId,
            Name = acc.Name,
            Address = acc.Address,
            PlannedCheckIn = acc.PlannedCheckIn,
            PlannedCheckOut = acc.PlannedCheckOut,
            EarliestCheckIn = acc.EarliestCheckIn,
            LatestCheckOut = acc.LatestCheckOut,
            Latitude = acc.Latitude,
            Longitude = acc.Longitude,
            Notes = acc.Notes,
            CreatedAt = acc.CreatedAt,
            UpdatedAt = acc.UpdatedAt
        };
        IsEditingAccommodation = true;
        _plannedCheckInString = acc.PlannedCheckIn.HasValue ? acc.PlannedCheckIn.Value.ToString("yyyy-MM-ddTHH:mm") : string.Empty;
        _plannedCheckOutString = acc.PlannedCheckOut.HasValue ? acc.PlannedCheckOut.Value.ToString("yyyy-MM-ddTHH:mm") : string.Empty;
        _earliestCheckInString = acc.EarliestCheckIn.HasValue ? acc.EarliestCheckIn.Value.ToString("HH:mm") : string.Empty;
        _latestCheckOutString = acc.LatestCheckOut.HasValue ? acc.LatestCheckOut.Value.ToString("HH:mm") : string.Empty;
        HideAccommodationDialog = false;
    }

    private async Task SaveAccommodation()
    {
        if (EditingAccommodation == null || string.IsNullOrWhiteSpace(EditingAccommodation.Name))
            return;

        EditingAccommodation.PlannedCheckIn = DateTime.TryParse(_plannedCheckInString, out var ci) ? ci : null;
        EditingAccommodation.PlannedCheckOut = DateTime.TryParse(_plannedCheckOutString, out var co) ? co : null;
        EditingAccommodation.EarliestCheckIn = TimeOnly.TryParse(_earliestCheckInString, out var eci) ? eci : null;
        EditingAccommodation.LatestCheckOut = TimeOnly.TryParse(_latestCheckOutString, out var lco) ? lco : null;

        if (IsEditingAccommodation)
        {
            await TripRepository.UpdateAccommodationAsync(EditingAccommodation);
            if (PlanningTrip != null)
            {
                var idx = PlanningTrip.Accommodations.FindIndex(a => a.Id == EditingAccommodation.Id);
                if (idx >= 0) PlanningTrip.Accommodations[idx] = EditingAccommodation;
            }
        }
        else
        {
            await TripRepository.AddAccommodationAsync(EditingAccommodation);
            PlanningTrip?.Accommodations.Add(EditingAccommodation);
        }

        HideAccommodationDialog = true;
        EditingAccommodation = null;
        StateHasChanged();
        await UpdateMapContent();
    }

    private async Task DeleteAccommodation(string accommodationId)
    {
        await TripRepository.DeleteAccommodationAsync(accommodationId);
        PlanningTrip?.Accommodations.RemoveAll(a => a.Id == accommodationId);
        StateHasChanged();
        await UpdateMapContent();
    }

    public async ValueTask DisposeAsync()
    {
        if (MapInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("mapInterop.destroyMap");
            }
            catch { }
        }
    }

}
