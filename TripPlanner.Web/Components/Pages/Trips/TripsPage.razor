@page "/trips"

@using Microsoft.AspNetCore.Authorization
@using TripPlanner.Web.Models
@using TripPlanner.Web.Repositories
@using TripPlanner.Web.Services

@attribute [Authorize]

@inject ITripRepository TripRepository
@inject IPlaceRepository PlaceRepository
@inject RoutingService RoutingService
@inject UserService UserService
@inject NavigationManager Navigation

@rendermode InteractiveServer

<PageTitle>Trips</PageTitle>
<FluentGrid Spacing="3" Justify="JustifyContent.FlexStart">

    <FluentGridItem xs="12">
        <FluentToolbar>
            <FluentLabel Typo="Typography.H3">
                <FluentIcon Value="@(new Icons.Regular.Size24.VehicleCar())" Color="Color.Accent" />
                My Trips
            </FluentLabel>
            <FluentSpacer />
            <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Add())" OnClick="@CreateNewTrip">
                Create Trip
            </FluentButton>
        </FluentToolbar>
    </FluentGridItem>

    @if (IsLoading)
    {
        <FluentGridItem xs="12">
            <FluentProgressRing />
        </FluentGridItem>
    }
    else if (!Trips.Any())
    {
        <FluentGridItem xs="12">
            <FluentCard>
                <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center">
                    <FluentIcon Icon="Icons.Regular.Size48.CalendarEmpty" Color="@Color.Accent" />
                    <FluentLabel Typo="Typography.Body">No trips planned yet. Create your first trip!</FluentLabel>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
    }
    else
    {
        @foreach (var trip in Trips)
        {
            <FluentGridItem xs="12" md="6" lg="4">
                <FluentCard Style="height: 100%;width: 100%">
                    <FluentStack Orientation="Orientation.Vertical" Style="width: 100%">
                        <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">@trip.Name</FluentLabel>
                        <FluentLabel Typo="Typography.Body">@trip.Description</FluentLabel>
                            
                        @if (trip.StartDate.HasValue || trip.EndDate.HasValue)
                        {
                            <FluentLabel Style="font-size: 0.875em;">
                                <FluentIcon Icon="Icons.Regular.Size16.Calendar" />
                                @if (trip.StartDate.HasValue)
                                {
                                    @trip.StartDate.Value.ToString("MMM dd, yyyy")
                                }
                                @if (trip.EndDate.HasValue)
                                {
                                    <text> - @trip.EndDate.Value.ToString("MMM dd, yyyy")</text>
                                }
                            </FluentLabel>
                        }
                            
                        <FluentLabel Style="font-size: 0.875em;">
                            <FluentIcon Icon="Icons.Regular.Size16.List" />
                            @trip.Days.Count days, @trip.Days.Sum(d => d.Places.Count) places
                        </FluentLabel>
                            
                        <FluentDivider />
                            
                        <FluentStack Orientation="Orientation.Horizontal">
                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Edit())" OnClick="@(() => EditTrip(trip))">
                                Edit
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.CalendarEdit())" OnClick="@(() => PlanTrip(trip))">
                                Plan
                            </FluentButton>
                            @if (trip.OwnerId == CurrentUserId)
                            {
                                <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Share())" OnClick="@(() => OpenShareDialog(trip))">
                                    Share
                                </FluentButton>
                            }
                            <FluentSpacer />
                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Delete())" OnClick="@(() => DeleteTrip(trip))">
                                Delete
                            </FluentButton>
                        </FluentStack>
                    </FluentStack>
                </FluentCard>
            </FluentGridItem>
        }
    }
</FluentGrid>


<FluentDialog @bind-Hidden="@HideAddDialog" Modal="true" TrapFocus="true" Style="width: 600px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">@(EditingTrip?.Id != null && Trips.Any(t => t.Id == EditingTrip.Id) ? "Edit Trip" : "Create New Trip")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (EditingTrip != null)
        {
            <FluentStack Orientation="Orientation.Vertical">
                <FluentTextField @bind-Value="@EditingTrip.Name" Label="Trip Name" Required Style="width: 100%;" />
                <FluentTextArea @bind-Value="@EditingTrip.Description" Label="Description" Rows="3" Style="width: 100%;" />
                
                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentTextField Value="@_startDateString" Label="Start Date (YYYY-MM-DD)" Style="width: 100%;" ValueChanged="@OnStartDateChanged" />
                    <FluentTextField Value="@_endDateString" Label="End Date (YYYY-MM-DD)" Style="width: 100%;" ValueChanged="@OnEndDateChanged" />
                </FluentStack>
                
                <FluentNumberField @bind-Value="@NumDays" Label="Number of Days" Min="1" Max="30" Style="width: 100%;" />
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveTrip">Save</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => HideAddDialog = true)">Cancel</FluentButton>
    </FluentDialogFooter>
</FluentDialog>


<FluentDialog @bind-Hidden="@HideShareDialog" Modal="true" TrapFocus="true" Style="width: 500px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">Share Trip: @SharingTrip?.Name</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (SharingTrip != null)
        {
            <FluentStack Orientation="Orientation.Vertical">
                @if (SharingTrip.SharedWith.Any())
                {
                    <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">Shared with:</FluentLabel>
                    @foreach (var shared in SharingTrip.SharedWith)
                    {
                        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                            <FluentLabel Style="flex: 1;">@(shared.User?.Email ?? shared.UserId)</FluentLabel>
                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Delete())" OnClick="@(() => UnshareTrip(shared.UserId))">
                                Remove
                            </FluentButton>
                        </FluentStack>
                    }
                    <FluentDivider />
                }
                <FluentTextField @bind-Value="@ShareEmail" Label="Share with (email address)" Style="width: 100%;" />
                @if (!string.IsNullOrEmpty(ShareMessage))
                {
                    <FluentLabel Style="font-size: 0.875em;">@ShareMessage</FluentLabel>
                }
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@ShareTrip">Share</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => HideShareDialog = true)">Close</FluentButton>
    </FluentDialogFooter>
</FluentDialog>


@code {
    private List<Trip> Trips { get; set; } = new();
    private List<Place> AllPlaces { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private bool HideAddDialog { get; set; } = true;
    private Trip? EditingTrip { get; set; }
    private int NumDays { get; set; } = 1;
    
    private string _startDateString = string.Empty;
    private string _endDateString = string.Empty;
    
    private string? CurrentUserId { get; set; }
    private bool HideShareDialog { get; set; } = true;
    private Trip? SharingTrip { get; set; }
    private string ShareEmail { get; set; } = string.Empty;
    private string? ShareMessage { get; set; }

    private void OnStartDateChanged(string value)
    {
        _startDateString = value;
        if (EditingTrip != null && DateTime.TryParse(value, out var date))
        {
            EditingTrip.StartDate = date;
        }
    }
    
    private void OnEndDateChanged(string value)
    {
        _endDateString = value;
        if (EditingTrip != null && DateTime.TryParse(value, out var date))
        {
            EditingTrip.EndDate = date;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        CurrentUserId = await UserService.GetCurrentUserIdAsync();
        await LoadData();
    }

    private async Task CreateNewTrip()
    {
        EditingTrip = new Trip { OwnerId = CurrentUserId ?? string.Empty };
        NumDays = 1;
        _startDateString = string.Empty;
        _endDateString = string.Empty;
        HideAddDialog = false;
    }

    private async Task PlanTrip(Trip trip)
    {
        Navigation.NavigateTo($"/trips/{trip.Id}");
    }

    private async Task LoadData()
    {
        IsLoading = true;
        
        if (CurrentUserId != null)
        {
            var ownedTrips = await TripRepository.GetByOwnerAsync(CurrentUserId);
            var sharedTrips = await TripRepository.GetSharedWithUserAsync(CurrentUserId);
            Trips = ownedTrips.Concat(sharedTrips).ToList();
            AllPlaces = await PlaceRepository.GetAllByUserAsync(CurrentUserId);
        }
        else
        {
            Trips = new List<Trip>();
            AllPlaces = new List<Place>();
        }
        
        
        // Load place details for all trips
        foreach (var trip in Trips)
        {
            foreach (var day in trip.Days)
            {
                foreach (var tripPlace in day.Places)
                {
                    tripPlace.Place = AllPlaces.FirstOrDefault(p => p.Id == tripPlace.PlaceId);
                }
            }
            
            foreach (var tripPlace in trip.UnscheduledPlaces)
            {
                tripPlace.Place = AllPlaces.FirstOrDefault(p => p.Id == tripPlace.PlaceId);
            }
        }
        
        IsLoading = false;
    }

    private void EditTrip(Trip trip)
    {
        EditingTrip = new Trip
        {
            Id = trip.Id,
            Name = trip.Name,
            Description = trip.Description,
            StartDate = trip.StartDate,
            EndDate = trip.EndDate,
            Days = trip.Days,
            UnscheduledPlaces = trip.UnscheduledPlaces,
            CreatedAt = trip.CreatedAt,
            UpdatedAt = trip.UpdatedAt
        };
        NumDays = trip.Days.Count;
        _startDateString = trip.StartDate?.ToString("yyyy-MM-dd") ?? string.Empty;
        _endDateString = trip.EndDate?.ToString("yyyy-MM-dd") ?? string.Empty;
        HideAddDialog = false;
    }

    private async Task DeleteTrip(Trip trip)
    {
        await TripRepository.DeleteAsync(trip.Id);
        await LoadData();
    }

    private async Task OpenShareDialog(Trip trip)
    {
        SharingTrip = await TripRepository.GetByIdAsync(trip.Id);
        ShareEmail = string.Empty;
        ShareMessage = null;
        HideShareDialog = false;
    }

    private async Task ShareTrip()
    {
        if (SharingTrip == null || string.IsNullOrWhiteSpace(ShareEmail))
            return;

        var userToShare = await UserService.GetUserByEmailAsync(ShareEmail);
        if (userToShare == null)
        {
            ShareMessage = "User not found.";
            return;
        }

        if (userToShare.Id == CurrentUserId)
        {
            ShareMessage = "You cannot share a trip with yourself.";
            return;
        }

        await TripRepository.ShareWithUserAsync(SharingTrip.Id, userToShare.Id);
        SharingTrip = await TripRepository.GetByIdAsync(SharingTrip.Id);
        ShareEmail = string.Empty;
        ShareMessage = "Trip shared successfully.";
    }

    private async Task UnshareTrip(string userId)
    {
        if (SharingTrip == null) return;
        await TripRepository.UnshareWithUserAsync(SharingTrip.Id, userId);
        SharingTrip = await TripRepository.GetByIdAsync(SharingTrip.Id);
        ShareMessage = null;
    }

    private async Task SaveTrip()
    {
        if (EditingTrip == null) return;

        // Create days if needed
        if (EditingTrip.Days.Count == 0 || EditingTrip.Days.Count != NumDays)
        {
            EditingTrip.Days.Clear();
            for (int i = 1; i <= NumDays; i++)
            {
                EditingTrip.Days.Add(new TripDay
                {
                    DayNumber = i,
                    Date = EditingTrip.StartDate?.AddDays(i - 1)
                });
            }
        }

        if (string.IsNullOrEmpty(EditingTrip.Id) || !Trips.Any(t => t.Id == EditingTrip.Id))
        {
            await TripRepository.AddAsync(EditingTrip);
        }
        else
        {
            await TripRepository.UpdateAsync(EditingTrip);
        }

        HideAddDialog = true;
        EditingTrip = null;
        await LoadData();
    }
}
