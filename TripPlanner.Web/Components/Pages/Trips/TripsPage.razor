@page "/trips"
@using TripPlanner.Web.Models
@using TripPlanner.Web.Repositories
@using TripPlanner.Web.Services
@inject ITripRepository TripRepository
@inject IPlaceRepository PlaceRepository
@inject RoutingService RoutingService
@rendermode InteractiveServer

<PageTitle>Trips</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Width="100%">
    <FluentToolbar>
        <FluentLabel Typo="Typography.H3">
            <FluentIcon Value="@(new Icons.Regular.Size24.VehicleCar())" Color="Color.Accent" />
            My Trips
        </FluentLabel>
        <FluentSpacer />
        <FluentButton Appearance="Appearance.Accent" OnClick="@CreateNewTrip">
            <FluentIcon Value="@(new Icons.Regular.Size20.Add())" Slot="start" />
            Create Trip
        </FluentButton>
    </FluentToolbar>

    @if (IsLoading)
    {
        <FluentProgressRing />
    }
    else if (!Trips.Any())
    {
        <FluentCard>
            <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center">
                <FluentIcon Value="@(new Icons.Regular.Size48.CalendarEmpty())" Color="Color.Neutral" />
                <FluentLabel Typo="Typography.Body">No trips planned yet. Create your first trip!</FluentLabel>
            </FluentStack>
        </FluentCard>
    }
    else
    {
        <FluentGrid Spacing="3" Justify="JustifyContent.FlexStart">
            @foreach (var trip in Trips)
            {
                <FluentGridItem xs="12" md="6" lg="4">
                    <FluentCard Style="height: 100%;">
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">@trip.Name</FluentLabel>
                            <FluentLabel Typo="Typography.Body">@trip.Description</FluentLabel>
                            
                            @if (trip.StartDate.HasValue || trip.EndDate.HasValue)
                            {
                                <FluentLabel Style="font-size: 0.875em;">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Calendar())" />
                                    @if (trip.StartDate.HasValue)
                                    {
                                        @trip.StartDate.Value.ToString("MMM dd, yyyy")
                                    }
                                    @if (trip.EndDate.HasValue)
                                    {
                                        <text> - @trip.EndDate.Value.ToString("MMM dd, yyyy")</text>
                                    }
                                </FluentLabel>
                            }
                            
                            <FluentLabel Style="font-size: 0.875em;">
                                <FluentIcon Value="@(new Icons.Regular.Size16.List())" />
                                @trip.Days.Count days, @trip.Days.Sum(d => d.Places.Count) places
                            </FluentLabel>
                            
                            <FluentDivider />
                            
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => ViewTrip(trip))">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Eye())" />
                                    View
                                </FluentButton>
                                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => EditTrip(trip))">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Edit())" />
                                    Edit
                                </FluentButton>
                                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => PlanTrip(trip))">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.CalendarEdit())" />
                                    Plan
                                </FluentButton>
                                <FluentSpacer />
                                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => DeleteTrip(trip))">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" Color="Color.Error" />
                                    Delete
                                </FluentButton>
                            </FluentStack>
                        </FluentStack>
                    </FluentCard>
                </FluentGridItem>
            }
        </FluentGrid>
    }
</FluentStack>

<FluentDialog @bind-Hidden="@HideAddDialog" Modal="true" TrapFocus="true" Style="width: 600px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">@(EditingTrip?.Id != null && Trips.Any(t => t.Id == EditingTrip.Id) ? "Edit Trip" : "Create New Trip")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (EditingTrip != null)
        {
            <FluentStack Orientation="Orientation.Vertical">
                <FluentTextField @bind-Value="@EditingTrip.Name" Label="Trip Name" Required Style="width: 100%;" />
                <FluentTextArea @bind-Value="@EditingTrip.Description" Label="Description" Rows="3" Style="width: 100%;" />
                
                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentTextField Value="@_startDateString" Label="Start Date (YYYY-MM-DD)" Style="width: 100%;" ValueChanged="@OnStartDateChanged" />
                    <FluentTextField Value="@_endDateString" Label="End Date (YYYY-MM-DD)" Style="width: 100%;" ValueChanged="@OnEndDateChanged" />
                </FluentStack>
                
                <FluentNumberField @bind-Value="@NumDays" Label="Number of Days" Min="1" Max="30" Style="width: 100%;" />
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveTrip">Save</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => HideAddDialog = true)">Cancel</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<FluentDialog @bind-Hidden="@HideViewDialog" Modal="true" TrapFocus="true" Style="width: 90%; max-width: 1200px;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">@ViewingTrip?.Name</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (ViewingTrip != null)
        {
            <FluentStack Orientation="Orientation.Vertical">
                <FluentLabel Typo="Typography.Body">@ViewingTrip.Description</FluentLabel>
                
                <FluentTabs>
                    @foreach (var day in ViewingTrip.Days.OrderBy(d => d.DayNumber))
                    {
                        <FluentTab Label="@($"Day {day.DayNumber}")">
                            <FluentCard>
                                <FluentStack Orientation="Orientation.Vertical">
                                    @if (day.Date.HasValue)
                                    {
                                        <FluentLabel Typo="Typography.Subject">
                                            <FluentIcon Value="@(new Icons.Regular.Size16.Calendar())" />
                                            @day.Date.Value.ToString("MMMM dd, yyyy")
                                        </FluentLabel>
                                    }
                                    
                                    @if (!day.Places.Any())
                                    {
                                        <FluentLabel Style="font-size: 0.875em;">No places scheduled for this day</FluentLabel>
                                    }
                                    else
                                    {
                                        var analysis = RoutingService.AnalyzeTripDay(day, AllPlaces);
                                        
                                        <FluentStack Orientation="Orientation.Horizontal" Wrap="true">
                                            <FluentBadge BackgroundColor="var(--neutral-layer-3)">
                                                Places: @day.Places.Count
                                            </FluentBadge>
                                            <FluentBadge BackgroundColor="var(--neutral-layer-3)">
                                                Total Time: @TimeSpan.FromMinutes(analysis.TotalMinutes).ToString(@"hh\:mm")
                                            </FluentBadge>
                                            <FluentBadge BackgroundColor="var(--neutral-layer-3)">
                                                Travel: @TimeSpan.FromMinutes(analysis.TotalTravelMinutes).ToString(@"hh\:mm")
                                            </FluentBadge>
                                        </FluentStack>
                                        
                                        @if (analysis.Warnings.Any())
                                        {
                                            <FluentMessageBar Intent="MessageIntent.Warning">
                                                @foreach (var warning in analysis.Warnings)
                                                {
                                                    <div>@warning</div>
                                                }
                                            </FluentMessageBar>
                                        }
                                        
                                        <FluentStack Orientation="Orientation.Vertical">
                                            @foreach (var tripPlace in day.Places.OrderBy(p => p.Order))
                                            {
                                                <FluentCard>
                                                    <FluentStack Orientation="Orientation.Horizontal">
                                                        <FluentLabel Weight="FontWeight.Bold">#@tripPlace.Order</FluentLabel>
                                                        <FluentLabel>@(tripPlace.Place?.Name ?? "Unknown")</FluentLabel>
                                                        @if (tripPlace.ScheduledTime.HasValue)
                                                        {
                                                            <FluentLabel>@tripPlace.ScheduledTime.Value.ToString("HH:mm")</FluentLabel>
                                                        }
                                                        @if (tripPlace.DurationMinutes.HasValue)
                                                        {
                                                            <FluentLabel>(@tripPlace.DurationMinutes min)</FluentLabel>
                                                        }
                                                    </FluentStack>
                                                    @if (!string.IsNullOrEmpty(tripPlace.Notes))
                                                    {
                                                        <FluentLabel Style="font-size: 0.875em;">Notes: @tripPlace.Notes</FluentLabel>
                                                    }
                                                </FluentCard>
                                            }
                                        </FluentStack>
                                    }
                                </FluentStack>
                            </FluentCard>
                        </FluentTab>
                    }
                    
                    @if (ViewingTrip.UnscheduledPlaces.Any())
                    {
                        <FluentTab Label="Unscheduled">
                            <FluentCard>
                                <FluentLabel Typo="Typography.Subject">Places to Schedule</FluentLabel>
                                <FluentStack Orientation="Orientation.Vertical">
                                    @foreach (var place in ViewingTrip.UnscheduledPlaces)
                                    {
                                        <FluentCard>
                                            <FluentLabel>@place.Place?.Name</FluentLabel>
                                        </FluentCard>
                                    }
                                </FluentStack>
                            </FluentCard>
                        </FluentTab>
                    }
                </FluentTabs>
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => HideViewDialog = true)">Close</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<FluentDialog @bind-Hidden="@HidePlanDialog" Modal="true" TrapFocus="true" Style="width: 95%; max-width: 1400px; height: 90vh;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">Plan Trip: @PlanningTrip?.Name</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody Style="overflow-y: auto; max-height: 70vh;">
        @if (PlanningTrip != null)
        {
            <FluentStack Orientation="Orientation.Horizontal" Style="height: 100%; gap: 16px;">
                <!-- Unscheduled Places -->
                <FluentCard Style="flex: 0 0 300px; min-height: 500px;">
                    <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">Available Places</FluentLabel>
                    <FluentLabel Style="font-size: 0.875em; margin-bottom: 8px;">Drag places to days to schedule them</FluentLabel>
                    
                    <FluentStack Orientation="Orientation.Vertical" Style="gap: 8px;">
                        @foreach (var place in AllPlaces)
                        {
                            var isScheduled = PlanningTrip.Days.Any(d => d.Places.Any(p => p.PlaceId == place.Id));
                            @if (!isScheduled)
                            {
                                <FluentCard class="draggable" 
                                           draggable="true"
                                           @ondragstart="@((e) => HandleDragStart(place.Id, null, -1))"
                                           @ondragend="@HandleDragEnd"
                                           Style="cursor: move; padding: 12px;">
                                    <FluentStack Orientation="Orientation.Vertical">
                                        <FluentLabel Weight="FontWeight.Bold">@place.Name</FluentLabel>
                                        <FluentBadge BackgroundColor="var(--neutral-layer-3)">@place.Category</FluentBadge>
                                        <FluentLabel Style="font-size: 0.875em;">
                                            @place.Latitude.ToString("F2"), @place.Longitude.ToString("F2")
                                        </FluentLabel>
                                    </FluentStack>
                                </FluentCard>
                            }
                        }
                    </FluentStack>
                </FluentCard>

                <!-- Days -->
                <FluentStack Orientation="Orientation.Vertical" Style="flex: 1; gap: 16px;">
                    @foreach (var day in PlanningTrip.Days.OrderBy(d => d.DayNumber))
                    {
                        <FluentCard class="drop-zone"
                                   @ondragover:preventDefault
                                   @ondragenter="@((e) => HandleDragEnter(day.Id))"
                                   @ondragleave="@((e) => HandleDragLeave())"
                                   @ondrop="@((e) => HandleDrop(day.Id))"
                                   Style="@(CurrentDropTarget == day.Id ? "background-color: var(--neutral-layer-2); border: 2px dashed var(--accent-fill-rest);" : "")">
                            <FluentStack Orientation="Orientation.Vertical">
                                <FluentStack Orientation="Orientation.Horizontal">
                                    <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">
                                        Day @day.DayNumber
                                    </FluentLabel>
                                    @if (day.Date.HasValue)
                                    {
                                        <FluentLabel Style="font-size: 0.875em;">
                                            - @day.Date.Value.ToString("MMM dd, yyyy")
                                        </FluentLabel>
                                    }
                                    <FluentSpacer />
                                    <FluentLabel Style="font-size: 0.875em;">
                                        @day.Places.Count places
                                    </FluentLabel>
                                </FluentStack>

                                <FluentDivider />

                                @if (!day.Places.Any())
                                {
                                    <FluentLabel Style="font-size: 0.875em; text-align: center; padding: 24px; color: var(--neutral-foreground-hint);">
                                        Drop places here to schedule
                                    </FluentLabel>
                                }
                                else
                                {
                                    <FluentStack Orientation="Orientation.Vertical" Style="gap: 8px;">
                                        @foreach (var tripPlace in day.Places.OrderBy(p => p.Order))
                                        {
                                            <FluentCard class="draggable"
                                                       draggable="true"
                                                       @ondragstart="@((e) => HandleDragStart(tripPlace.PlaceId, day.Id, tripPlace.Order))"
                                                       @ondragend="@HandleDragEnd"
                                                       Style="cursor: move; padding: 8px;">
                                                <FluentStack Orientation="Orientation.Horizontal">
                                                    <FluentIcon Value="@(new Icons.Regular.Size16.Navigation())" />
                                                    <FluentLabel Weight="FontWeight.Bold">@(tripPlace.Place?.Name ?? "Unknown")</FluentLabel>
                                                    <FluentSpacer />
                                                    <FluentButton Appearance="Appearance.Lightweight" 
                                                                 OnClick="@(() => RemovePlaceFromDay(day.Id, tripPlace.PlaceId))"
                                                                 Style="padding: 4px;">
                                                        <FluentIcon Value="@(new Icons.Regular.Size12.Dismiss())" />
                                                    </FluentButton>
                                                </FluentStack>
                                            </FluentCard>
                                        }
                                    </FluentStack>
                                }
                            </FluentStack>
                        </FluentCard>
                    }
                </FluentStack>
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveTripPlan">Save Plan</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => HidePlanDialog = true)">Cancel</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<Trip> Trips { get; set; } = new();
    private List<Place> AllPlaces { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private bool HideAddDialog { get; set; } = true;
    private bool HideViewDialog { get; set; } = true;
    private bool HidePlanDialog { get; set; } = true;
    private Trip? EditingTrip { get; set; }
    private Trip? ViewingTrip { get; set; }
    private Trip? PlanningTrip { get; set; }
    private int NumDays { get; set; } = 1;
    
    private string _startDateString = string.Empty;
    private string _endDateString = string.Empty;

    // Drag and drop state
    private string? DraggedPlaceId { get; set; }
    private string? DraggedFromDayId { get; set; }
    private int DraggedFromOrder { get; set; }
    private string? CurrentDropTarget { get; set; }
    
    private void OnStartDateChanged(string value)
    {
        _startDateString = value;
        if (EditingTrip != null && DateTime.TryParse(value, out var date))
        {
            EditingTrip.StartDate = date;
        }
    }
    
    private void OnEndDateChanged(string value)
    {
        _endDateString = value;
        if (EditingTrip != null && DateTime.TryParse(value, out var date))
        {
            EditingTrip.EndDate = date;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private void CreateNewTrip()
    {
        EditingTrip = new Trip();
        NumDays = 1;
        _startDateString = string.Empty;
        _endDateString = string.Empty;
        HideAddDialog = false;
    }

    private async Task LoadData()
    {
        IsLoading = true;
        Trips = await TripRepository.GetAllAsync();
        AllPlaces = await PlaceRepository.GetAllAsync();
        
        // Load place details for all trips
        foreach (var trip in Trips)
        {
            foreach (var day in trip.Days)
            {
                foreach (var tripPlace in day.Places)
                {
                    tripPlace.Place = AllPlaces.FirstOrDefault(p => p.Id == tripPlace.PlaceId);
                }
            }
            
            foreach (var tripPlace in trip.UnscheduledPlaces)
            {
                tripPlace.Place = AllPlaces.FirstOrDefault(p => p.Id == tripPlace.PlaceId);
            }
        }
        
        IsLoading = false;
    }

    private void EditTrip(Trip trip)
    {
        EditingTrip = new Trip
        {
            Id = trip.Id,
            Name = trip.Name,
            Description = trip.Description,
            StartDate = trip.StartDate,
            EndDate = trip.EndDate,
            Days = trip.Days,
            UnscheduledPlaces = trip.UnscheduledPlaces,
            CreatedAt = trip.CreatedAt,
            UpdatedAt = trip.UpdatedAt
        };
        NumDays = trip.Days.Count;
        _startDateString = trip.StartDate?.ToString("yyyy-MM-dd") ?? string.Empty;
        _endDateString = trip.EndDate?.ToString("yyyy-MM-dd") ?? string.Empty;
        HideAddDialog = false;
    }

    private void ViewTrip(Trip trip)
    {
        ViewingTrip = trip;
        HideViewDialog = false;
    }

    private void PlanTrip(Trip trip)
    {
        // Create a deep copy for planning
        PlanningTrip = new Trip
        {
            Id = trip.Id,
            Name = trip.Name,
            Description = trip.Description,
            StartDate = trip.StartDate,
            EndDate = trip.EndDate,
            CreatedAt = trip.CreatedAt,
            UpdatedAt = trip.UpdatedAt,
            Days = trip.Days.Select(d => new TripDay
            {
                Id = d.Id,
                DayNumber = d.DayNumber,
                Date = d.Date,
                Places = d.Places.Select(p => new TripPlace
                {
                    PlaceId = p.PlaceId,
                    Order = p.Order,
                    ScheduledTime = p.ScheduledTime,
                    DurationMinutes = p.DurationMinutes,
                    Notes = p.Notes,
                    Place = AllPlaces.FirstOrDefault(pl => pl.Id == p.PlaceId)
                }).ToList()
            }).ToList(),
            UnscheduledPlaces = trip.UnscheduledPlaces.ToList()
        };

        HidePlanDialog = false;
    }

    // Drag and drop handlers
    private void HandleDragStart(string placeId, string? fromDayId, int fromOrder)
    {
        DraggedPlaceId = placeId;
        DraggedFromDayId = fromDayId;
        DraggedFromOrder = fromOrder;
    }

    private void HandleDragEnd()
    {
        // Keep the state until drop completes
    }

    private void HandleDragEnter(string dayId)
    {
        CurrentDropTarget = dayId;
    }

    private void HandleDragLeave()
    {
        CurrentDropTarget = null;
    }

    private void HandleDrop(string toDayId)
    {
        CurrentDropTarget = null;

        if (PlanningTrip == null || string.IsNullOrEmpty(DraggedPlaceId))
            return;

        var toDay = PlanningTrip.Days.FirstOrDefault(d => d.Id == toDayId);
        if (toDay == null)
            return;

        // Remove from source if it was in a day
        if (!string.IsNullOrEmpty(DraggedFromDayId))
        {
            var fromDay = PlanningTrip.Days.FirstOrDefault(d => d.Id == DraggedFromDayId);
            if (fromDay != null)
            {
                var placeToMove = fromDay.Places.FirstOrDefault(p => p.PlaceId == DraggedPlaceId);
                if (placeToMove != null)
                {
                    fromDay.Places.Remove(placeToMove);
                    // Reorder remaining places
                    var order = 1;
                    foreach (var p in fromDay.Places.OrderBy(p => p.Order))
                    {
                        p.Order = order++;
                    }
                }
            }
        }

        // Add to target day
        var place = AllPlaces.FirstOrDefault(p => p.Id == DraggedPlaceId);
        if (place != null)
        {
            var newOrder = toDay.Places.Any() ? toDay.Places.Max(p => p.Order) + 1 : 1;
            toDay.Places.Add(new TripPlace
            {
                PlaceId = place.Id,
                Order = newOrder,
                Place = place
            });
        }

        // Clear drag state
        DraggedPlaceId = null;
        DraggedFromDayId = null;
        DraggedFromOrder = -1;

        StateHasChanged();
    }

    private void RemovePlaceFromDay(string dayId, string placeId)
    {
        if (PlanningTrip == null)
            return;

        var day = PlanningTrip.Days.FirstOrDefault(d => d.Id == dayId);
        if (day != null)
        {
            var placeToRemove = day.Places.FirstOrDefault(p => p.PlaceId == placeId);
            if (placeToRemove != null)
            {
                day.Places.Remove(placeToRemove);
                // Reorder remaining places
                var order = 1;
                foreach (var p in day.Places.OrderBy(p => p.Order))
                {
                    p.Order = order++;
                }
            }
        }
    }

    private async Task SaveTripPlan()
    {
        if (PlanningTrip == null)
            return;

        PlanningTrip.UpdatedAt = DateTime.UtcNow;
        await TripRepository.UpdateAsync(PlanningTrip);

        HidePlanDialog = true;
        PlanningTrip = null;
        await LoadData();
    }

    private async Task DeleteTrip(Trip trip)
    {
        await TripRepository.DeleteAsync(trip.Id);
        await LoadData();
    }

    private async Task SaveTrip()
    {
        if (EditingTrip == null) return;

        // Create days if needed
        if (EditingTrip.Days.Count == 0 || EditingTrip.Days.Count != NumDays)
        {
            EditingTrip.Days.Clear();
            for (int i = 1; i <= NumDays; i++)
            {
                EditingTrip.Days.Add(new TripDay
                {
                    DayNumber = i,
                    Date = EditingTrip.StartDate?.AddDays(i - 1)
                });
            }
        }

        if (string.IsNullOrEmpty(EditingTrip.Id) || !Trips.Any(t => t.Id == EditingTrip.Id))
        {
            await TripRepository.AddAsync(EditingTrip);
        }
        else
        {
            await TripRepository.UpdateAsync(EditingTrip);
        }

        HideAddDialog = true;
        EditingTrip = null;
        await LoadData();
    }
}
