@page "/wishlist"

@using TripPlanner.Web.Models
@using TripPlanner.Web.Repositories
@using TripPlanner.Web.Services
@using TripPlanner.Web.Components.Shared
@using static TripPlanner.Web.Components.Shared.GpxFileUpload

@inject IPlaceRepository PlaceRepository
@inject IGpxRepository GpxRepository
@inject GpxService GpxService

@rendermode InteractiveServer

<PageTitle>Wishlist</PageTitle>

<FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Stretch" Width="100%">
    <FluentToolbar>
        <FluentLabel Typo="Typography.H3">
            <FluentIcon Icon="Icons.Regular.Size24.Heart" Color="Color.Accent" />
            Place Wishlist
        </FluentLabel>
        <FluentSpacer />
        <FluentButton Appearance="Appearance.Accent" OnClick="@CreateNewPlace" IconStart="@(new Icons.Regular.Size20.Add())">
            Add Place
        </FluentButton>
    </FluentToolbar>

    <FluentCard AreaRestricted="false">
        <FluentStack Orientation="Orientation.Horizontal" Width="100%" Wrap="true">
            <FluentSelect TOption="string" @bind-Value="@FilterCategoryString" Label="Category" Style="min-width: 200px;">
                <FluentOption TOption="string" Value="">All Categories</FluentOption>
                @foreach (var category in Enum.GetValues<PlaceCategory>())
                {
                    <FluentOption TOption="string" Value="@category.ToString()">@category.ToString()</FluentOption>
                }
            </FluentSelect>
            
            <FluentCheckbox @bind-Value="@FilterHasGpxValue" Label="Has GPX Track" />
            
            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size20.Filter())" OnClick="@ApplyFilters">
                Apply Filters
            </FluentButton>
            
            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size20.Eraser())" OnClick="@ClearFilters">
                Clear
            </FluentButton>
        </FluentStack>
    </FluentCard>

    @if (IsLoading)
    {
        <FluentProgressRing />
    }
    else if (!Places.Any())
    {
        <FluentCard>
            <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center">
                <FluentIcon Icon="Icons.Regular.Size48.LocationOff" Color="Color.Neutral" />
                <FluentLabel Typo="Typography.Body">No places in your wishlist yet. Add your first place!</FluentLabel>
            </FluentStack>
        </FluentCard>
    }
    else
    {
        <FluentGrid Spacing="3" Justify="JustifyContent.FlexStart">
            @foreach (var place in Places)
            {
                <FluentGridItem xs="12" md="6" lg="3" xl="2" xxl="2">
                    <FluentCard Style="@GetCardStyle(place)">
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">@place.Name</FluentLabel>
                                @if (place.HasGpxTrack)
                                {
                                    <FluentSpacer />
                                    <FluentBadge Appearance="Appearance.Accent">GPX</FluentBadge>
                                }
                            </FluentStack>
                            <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation" />
                            
                            <FluentLabel Typo="Typography.Body">@place.Description</FluentLabel>
                            
                            <FluentStack Orientation="Orientation.Horizontal" Wrap="true">
                                <FluentBadge BackgroundColor="var(--neutral-layer-3)">@place.Category</FluentBadge>
                                @if (place.Wishlist is not null)
                                {
                                    <FluentBadge BackgroundColor="var(--neutral-layer-3)">@place.Wishlist.Name</FluentBadge>
                                }
                            </FluentStack>
                            
                            @if (place.Tags.Any())
                            {
                                <FluentStack Orientation="Orientation.Horizontal" Wrap="true">
                                    @foreach (var tag in place.Tags)
                                    {
                                        <FluentBadge BackgroundColor="var(--accent-fill-rest)">@tag</FluentBadge>
                                    }
                                </FluentStack>
                            }
                            
                            <FluentLabel Style="font-size: 0.875em;">
                                <FluentIcon Icon="Icons.Regular.Size16.Location" />
                                @place.Latitude.ToString("F4"), @place.Longitude.ToString("F4")
                            </FluentLabel>
                            
                            <FluentDivider />
                            
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Edit())" OnClick="@(() => EditPlace(place))">
                                    Edit
                                </FluentButton>
                                <FluentSpacer />
                                <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Delete())" OnClick="@(() => DeletePlace(place))">
                                    Delete
                                </FluentButton>
                            </FluentStack>
                        </FluentStack>
                    </FluentCard>
                </FluentGridItem>
            }
        </FluentGrid>
    }
</FluentStack>

<FluentDialog @bind-Hidden="@HideAddDialog" Modal="true" TrapFocus="true">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">@(EditingPlace?.Id != null ? "Edit Place" : "Add New Place")</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        @if (EditingPlace != null)
        {
            <FluentStack Orientation="Orientation.Vertical">
                <FluentTextField @bind-Value="@EditingPlace.Name" Label="Name" Required Style="width: 100%;" />
                <FluentTextArea @bind-Value="@EditingPlace.Description" Label="Description" Rows="3" Style="width: 100%;" />
                
                <FluentSelect TOption="string" Value="@_selectedCategoryString" Label="Category" Style="width: 100%;" ValueChanged="@OnCategoryChanged">
                    @foreach (var category in Enum.GetValues<PlaceCategory>())
                    {
                        <FluentOption TOption="string" Value="@category.ToString()">@category.ToString()</FluentOption>
                    }
                </FluentSelect>
                
                <FluentTextField @bind-Value="@EditingPlace.LatitudeString" Label="Latitude" Style="width: 100%;" />
                <FluentTextField @bind-Value="@EditingPlace.LongitudeString" Label="Longitude" Style="width: 100%;" />

                
                <FluentTextField @bind-Value="@NewTag" Label="Add Tags" Placeholder="Type and press Enter"
                                 @onkeydown="@HandleTagKeyDown" Style="width: 100%;" />
                
                <FluentStack Orientation="Orientation.Horizontal" Wrap="true">
                    @foreach (var tag in EditingPlace.Tags)
                    {
                        <FluentBadge BackgroundColor="var(--accent-fill-rest)">
                            @tag
                            <FluentButton Appearance="Appearance.Lightweight" IconEnd="@(new Icons.Regular.Size12.Dismiss())" OnClick="@(() => RemoveTag(tag))" Style="padding: 0; margin-left: 4px;"></FluentButton>
                        </FluentBadge>
                    }
                </FluentStack>

                <FluentDivider />
                
                <FluentLabel Typo="Typography.Subject">GPX Track (Optional)</FluentLabel>
                @if (!string.IsNullOrEmpty(EditingPlace.GpxTrackId))
                {
                    var gpxTrack = GpxTracks.FirstOrDefault(g => g.Id == EditingPlace.GpxTrackId);
                    @if (gpxTrack != null)
                    {
                        <FluentCard>
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentIcon Icon="Icons.Regular.Size20.Location" Color="Color.Accent" />
                                <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                                    <FluentLabel Weight="FontWeight.Bold">@gpxTrack.Name</FluentLabel>
                                    <FluentLabel Style="font-size: 0.875em;">
                                        Distance: @gpxTrack.TotalDistance.ToString("F2") km | Points: @gpxTrack.Points.Count
                                    </FluentLabel>
                                </FluentStack>
                                <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Delete())" OnClick="@RemoveGpxTrack">
                                </FluentButton>
                            </FluentStack>
                        </FluentCard>
                    }
                }
                else
                {
                    <GpxFileUpload OnFileUploaded="@HandleGpxUploaded" />
                }
            </FluentStack>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SavePlace">Save</FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => HideAddDialog = true)">Cancel</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private string GetCardStyle(Place place)
    {
        if (place.ImageData != null && place.ImageContentType != null
            && System.Text.RegularExpressions.Regex.IsMatch(place.ImageContentType, @"^image/[a-zA-Z0-9\-\+\.]+$"))
        {
            if (!_cardStyleCache.TryGetValue(place.Id, out var style))
            {
                var base64 = Convert.ToBase64String(place.ImageData);
                style = $"height: 100%; background-image: linear-gradient(rgba(255,255,255,0.82), rgba(255,255,255,0.82)), url('data:{place.ImageContentType};base64,{base64}'); background-size: cover; background-position: center;";
                _cardStyleCache[place.Id] = style;
            }
            return style;
        }
        return "height: 100%;";
    }

    private List<Place> Places { get; set; } = new();
    private Dictionary<string, string> _cardStyleCache = new();
    private List<GpxTrack> GpxTracks { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private bool HideAddDialog { get; set; } = true;
    private Place? EditingPlace { get; set; }
    private PlaceCategory? FilterCategory { get; set; }
    private string FilterCategoryString { get; set; } = string.Empty;
    private bool? FilterHasGpx { get; set; }
    private bool FilterHasGpxValue { get; set; }
    private string NewTag { get; set; } = string.Empty;
    private string _selectedCategoryString = string.Empty;

    private void OnCategoryChanged(string value)
    {
        _selectedCategoryString = value;
        if (EditingPlace != null && Enum.TryParse<PlaceCategory>(value, out var category))
        {
            EditingPlace.Category = category;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPlaces();
        await LoadGpxTracks();
    }

    private async Task LoadPlaces()
    {
        IsLoading = true;
        Places = await PlaceRepository.GetAllWithAnyWishlistAsync();
        _cardStyleCache.Clear();
        IsLoading = false;
    }

    private async Task LoadGpxTracks()
    {
        GpxTracks = await GpxRepository.GetAllAsync();
    }

    private async Task ApplyFilters()
    {
        IsLoading = true;
        FilterCategory = string.IsNullOrEmpty(FilterCategoryString) ? null : Enum.Parse<PlaceCategory>(FilterCategoryString);
        FilterHasGpx = FilterHasGpxValue ? true : (bool?)null;
        Places = await PlaceRepository.FilterAsync(FilterCategory, null, FilterHasGpx);
        _cardStyleCache.Clear();
        IsLoading = false;
    }

    private async Task ClearFilters()
    {
        FilterCategory = null;
        FilterCategoryString = string.Empty;
        FilterHasGpx = null;
        FilterHasGpxValue = false;
        await LoadPlaces();
    }

    private void CreateNewPlace()
    {
        EditingPlace = new Place();
        _selectedCategoryString = EditingPlace.Category.ToString();
        HideAddDialog = false;
    }

    private void EditPlace(Place place)
    {
        EditingPlace = new Place
        {
            Id = place.Id,
            Name = place.Name,
            Description = place.Description,
            Category = place.Category,
            Latitude = place.Latitude,
            Longitude = place.Longitude,
            Tags = new List<string>(place.Tags),
            GpxTrackId = place.GpxTrackId,
            CreatedAt = place.CreatedAt,
            UpdatedAt = place.UpdatedAt
        };
        _selectedCategoryString = EditingPlace.Category.ToString();
        HideAddDialog = false;
    }

    private async Task DeletePlace(Place place)
    {
        await PlaceRepository.DeleteAsync(place.Id);
        await LoadPlaces();
    }

    private async Task SavePlace()
    {
        if (EditingPlace == null) return;

        if (string.IsNullOrEmpty(EditingPlace.Id) || !Places.Any(p => p.Id == EditingPlace.Id))
        {
            await PlaceRepository.AddAsync(EditingPlace);
        }
        else
        {
            await PlaceRepository.UpdateAsync(EditingPlace);
        }

        HideAddDialog = true;
        EditingPlace = null;
        await LoadPlaces();
    }

    private void HandleTagKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(NewTag))
        {
            if (EditingPlace != null && !EditingPlace.Tags.Contains(NewTag))
            {
                EditingPlace.Tags.Add(NewTag);
                NewTag = string.Empty;
            }
        }
    }

    private void RemoveTag(string tag)
    {
        EditingPlace?.Tags.Remove(tag);
    }

    private async Task HandleGpxUploaded(GpxUploadResult result)
    {
        if (result.Success && EditingPlace != null)
        {
            try
            {
                // Parse the GPX file
                var gpxTrack = GpxService.ParseGpxContent(result.Content, result.FileName);
                gpxTrack.CreatedAt = DateTime.UtcNow;

                // Save the GPX track
                await GpxRepository.AddAsync(gpxTrack);

                // Link it to the place
                EditingPlace.GpxTrackId = gpxTrack.Id;

                // Reload GPX tracks
                await LoadGpxTracks();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error processing GPX file: {ex.Message}");
            }
        }
    }

    private void RemoveGpxTrack()
    {
        if (EditingPlace != null)
        {
            EditingPlace.GpxTrackId = null;
        }
    }
}
