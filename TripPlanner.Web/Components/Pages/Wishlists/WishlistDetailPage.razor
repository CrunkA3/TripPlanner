@page "/wishlists/{WishlistId}"

@using Microsoft.AspNetCore.Authorization
@using TripPlanner.Web.Components.Shared
@using TripPlanner.Web.Models
@using TripPlanner.Web.Repositories
@using TripPlanner.Web.Services

@attribute [Authorize]

@inject IWishlistRepository WishlistRepository
@inject IPlaceRepository PlaceRepository
@inject UserService UserService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<PageTitle>@(wishlist?.Name ?? "Wishlist")</PageTitle>

@if (wishlist == null)
{
    <FluentProgressRing>Loading wishlist...</FluentProgressRing>
}
else if (!canAccess)
{
    <FluentMessageBar Intent="MessageIntent.Error">
        You do not have permission to view this wishlist.
    </FluentMessageBar>
}
else
{
    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Stretch" Width="100%">
        <FluentToolbar>
            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size20.ArrowLeft())" OnClick="@(() => NavigationManager.NavigateTo("/wishlists"))">
                Back to Wishlists
            </FluentButton>
            <FluentSpacer />
            <FluentLabel Typo="Typography.H3">
                <FluentIcon Icon="Icons.Regular.Size24.Heart" Color="Color.Accent" />
                @wishlist.Name
            </FluentLabel>
            <FluentSpacer />
            @if (canEdit)
            {
                <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Add())" OnClick="@ShowAddPlaceDialog">
                    Add Place
                </FluentButton>
            }
        </FluentToolbar>

        @if (!string.IsNullOrEmpty(wishlist.Description))
        {
            <FluentCard>
                <FluentLabel>@wishlist.Description</FluentLabel>
            </FluentCard>
        }

        @if (places == null)
        {
            <FluentProgressRing>Loading places...</FluentProgressRing>
        }
        else if (!places.Any())
        {
            <FluentCard>
                <p>This wishlist doesn't have any places yet. Click "Add Place" to start adding places.</p>
            </FluentCard>
        }
        else
        {
            <WishlistPlacesGrid Places="places" CanEdit="@canEdit" OnEditPlace="EditPlace" OnDeletePlace="DeletePlace" OnNotesPlace="OpenNotes" />
        }
    </FluentStack>
}

<FluentDialogProvider />



@code {
    [Parameter]
    public string WishlistId { get; set; } = string.Empty;

    private Wishlist? wishlist;
    private List<Place>? places;
    private bool canAccess;
    private bool canEdit;
    private string? currentUserId;



    protected override async Task OnInitializedAsync()
    {
        currentUserId = await UserService.GetCurrentUserIdAsync();
        if (currentUserId != null)
        {
            await LoadWishlist();
        }
    }

    private async Task LoadWishlist()
    {
        if (currentUserId == null) return;

        wishlist = await WishlistRepository.GetByIdAsync(WishlistId);
        if (wishlist != null)
        {
            canAccess = await WishlistRepository.CanUserAccessAsync(WishlistId, currentUserId);
            if (canAccess)
            {
                canEdit = await WishlistRepository.CanUserEditAsync(WishlistId, currentUserId);
                await LoadPlaces();
            }
        }
    }

    private async Task LoadPlaces()
    {
        places = await PlaceRepository.GetByWishlistIdAsync(WishlistId);
    }

    private async Task ShowAddPlaceDialog()
    {
        var dialog = await DialogService.ShowDialogAsync<WishlistAddPlaceDialog>(new Place() { WishlistId = WishlistId }, new DialogParameters()
        {
            PreventDismissOnOverlayClick = true,
            PreventScroll = true,
            TrapFocus = true
        });

        var result = await dialog.Result;

        if (!result.Cancelled && result.Data is not null)
        {
            
            await LoadPlaces();
            StateHasChanged();
        }
    }

    private async Task EditPlace(Place place)
    {
        var dialog = await DialogService.ShowDialogAsync<WishlistAddPlaceDialog>(place, new DialogParameters()
        {
            Title = "Edit Place",
            PreventDismissOnOverlayClick = true,
            PreventScroll = true,
            TrapFocus = true
        });

        var result = await dialog.Result;

        if (!result.Cancelled && result.Data is not null)
        {
            StateHasChanged();
        }
    }

    private async Task OpenNotes(Place place)
    {
        var panel = await DialogService.ShowPanelAsync<PlaceNotesDrawer>(place, new DialogParameters()
        {
            Title = $"Notes: {place.Name}",
            Width = "min(95vw, 1000px)",
            PreventDismissOnOverlayClick = false,
        });

        await panel.Result;
    }

    private async Task DeletePlace(string placeId)
    {
        await PlaceRepository.DeleteAsync(placeId);
        await LoadPlaces();
    }
}
