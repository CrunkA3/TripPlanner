@page "/wishlists/{WishlistId}"

@using Microsoft.AspNetCore.Authorization
@using TripPlanner.Web.Models
@using TripPlanner.Web.Repositories
@using TripPlanner.Web.Services

@attribute [Authorize]

@inject IWishlistRepository WishlistRepository
@inject IPlaceRepository PlaceRepository
@inject UserService UserService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<PageTitle>@wishlist?.Name ?? "Wishlist"</PageTitle>

@if (wishlist == null)
{
    <FluentProgressRing>Loading wishlist...</FluentProgressRing>
}
else if (!canAccess)
{
    <FluentMessageBar Intent="MessageIntent.Error">
        You do not have permission to view this wishlist.
    </FluentMessageBar>
}
else
{
    <FluentStack Orientation="Orientation.Vertical" Width="100%">
        <FluentToolbar>
            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => NavigationManager.NavigateTo("/wishlists"))">
                <FluentIcon Value="@(new Icons.Regular.Size20.ArrowLeft())" Slot="start" />
                Back to Wishlists
            </FluentButton>
            <FluentSpacer />
            <FluentLabel Typo="Typography.H3">
                <FluentIcon Value="@(new Icons.Regular.Size24.Heart())" Color="Color.Accent" />
                @wishlist.Name
            </FluentLabel>
            <FluentSpacer />
            <FluentButton Appearance="Appearance.Accent" OnClick="@ShowAddPlaceDialog">
                <FluentIcon Value="@(new Icons.Regular.Size20.Add())" Slot="start" />
                Add Place
            </FluentButton>
        </FluentToolbar>

        @if (!string.IsNullOrEmpty(wishlist.Description))
        {
            <FluentCard>
                <p>@wishlist.Description</p>
            </FluentCard>
        }

        @if (places == null)
        {
            <FluentProgressRing>Loading places...</FluentProgressRing>
        }
        else if (!places.Any())
        {
            <FluentCard>
                <p>This wishlist doesn't have any places yet. Click "Add Place" to start adding places.</p>
            </FluentCard>
        }
        else
        {
            <FluentStack Orientation="Orientation.Horizontal" Wrap="true" Width="100%" HorizontalGap="10" VerticalGap="10">
                @foreach (var place in places)
                {
                    <FluentCard Style="width: 250px; height: 300px;">
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentLabel Typo="Typography.H5">@place.Name</FluentLabel>
                            <FluentBadge Appearance="Appearance.Accent">@place.Category</FluentBadge>
                            <p>@place.Description</p>
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentIcon Value="@(new Icons.Regular.Size16.Location())" />
                                <span>@place.Latitude.ToString("F4"), @place.Longitude.ToString("F4")</span>
                            </FluentStack>
                            @if (place.Tags.Any())
                            {
                                <FluentStack Orientation="Orientation.Horizontal" Wrap="true">
                                    @foreach (var tag in place.Tags)
                                    {
                                        <FluentBadge>@tag</FluentBadge>
                                    }
                                </FluentStack>
                            }
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => EditPlace(place))">
                                    Edit
                                </FluentButton>
                                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => DeletePlace(place.Id))">
                                    Delete
                                </FluentButton>
                            </FluentStack>
                        </FluentStack>
                    </FluentCard>
                }
            </FluentStack>
        }
    </FluentStack>
}

<FluentDialogProvider />



@code {
    [Parameter]
    public string WishlistId { get; set; } = string.Empty;

    private Wishlist? wishlist;
    private List<Place>? places;
    private bool canAccess;
    private string? currentUserId;



    protected override async Task OnInitializedAsync()
    {
        currentUserId = await UserService.GetCurrentUserIdAsync();
        if (currentUserId != null)
        {
            await LoadWishlist();
        }
    }

    private async Task LoadWishlist()
    {
        if (currentUserId == null) return;

        wishlist = await WishlistRepository.GetByIdAsync(WishlistId);
        if (wishlist != null)
        {
            canAccess = await WishlistRepository.CanUserAccessAsync(WishlistId, currentUserId);
            if (canAccess)
            {
                await LoadPlaces();
            }
        }
    }

    private async Task LoadPlaces()
    {
        places = await PlaceRepository.GetByWishlistIdAsync(WishlistId);
    }

    private async Task ShowAddPlaceDialog()
    {
        var dialog = await DialogService.ShowDialogAsync<WishlistAddPlaceDialog>(new Place() { WishlistId = WishlistId }, new DialogParameters()
        {
            PreventDismissOnOverlayClick = true,
            PreventScroll = true,
            TrapFocus = true
        });

        var result = await dialog.Result;

        if (!result.Cancelled && result.Data is not null)
        {
            
            await LoadPlaces();
            StateHasChanged();
        }
    }

    private async Task EditPlace(Place place)
    {
        var dialog = await DialogService.ShowDialogAsync<WishlistAddPlaceDialog>(place, new DialogParameters()
        {
            PreventDismissOnOverlayClick = true,
            PreventScroll = true,
            TrapFocus = true
        });

        var result = await dialog.Result;

        if (!result.Cancelled && result.Data is not null)
        {
            StateHasChanged();
        }
    }

    private async Task DeletePlace(string placeId)
    {
        await PlaceRepository.DeleteAsync(placeId);
        await LoadPlaces();
    }
}
