@page "/wishlists"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using TripPlanner.Web.Models
@using TripPlanner.Web.Repositories
@using TripPlanner.Web.Services

@attribute [Authorize]

@inject IWishlistRepository WishlistRepository
@inject UserService UserService
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<PageTitle>My Wishlists</PageTitle>

<h1>My Wishlists</h1>

<FluentStack Orientation="Orientation.Horizontal" Style="margin-bottom: 20px;">
    <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Add())" OnClick="@ShowCreateDialog">
        Create Wishlist
        </FluentButton>
</FluentStack>

@if (ownedWishlists == null || sharedWishlists == null)
{
    <FluentProgressRing>Loading...</FluentProgressRing>
}
else
{
    <h2>My Wishlists</h2>
    @if (!ownedWishlists.Any())
    {
        <FluentCard class="wishlist-empty-card">
            <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="padding: 2rem;">
                <FluentIcon Value="@(new Icons.Regular.Size48.Heart())" Color="Color.Neutral" />
                <FluentLabel Typo="Typography.Body">You haven't created any wishlists yet. Click "Create Wishlist" to get started!</FluentLabel>
            </FluentStack>
        </FluentCard>
    }
    else
    {
        <FluentGrid Spacing="3" Justify="JustifyContent.FlexStart" Style="margin-bottom: 30px;">
            @foreach (var wishlist in ownedWishlists)
            {
                <FluentGridItem xs="12" sm="6" md="4" lg="3">
                    <FluentCard class="wishlist-card">
                        <FluentStack Orientation="Orientation.Vertical" Style="height: 100%;">
                            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                                <FluentIcon Value="@(new Icons.Regular.Size24.Heart())" Color="Color.Accent" />
                                <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold" Style="margin-left: 0.5rem; flex: 1;">@wishlist.Name</FluentLabel>
                            </FluentStack>
                            <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation" />
                            @if (!string.IsNullOrEmpty(wishlist.Description))
                            {
                                <FluentLabel Typo="Typography.Body" Style="flex: 1;">@wishlist.Description</FluentLabel>
                            }
                            else
                            {
                                <FluentLabel Typo="Typography.Body" Style="flex: 1; color: var(--neutral-foreground-hint); font-style: italic;">No description</FluentLabel>
                            }
                            <FluentSpacer />
                            <FluentStack Orientation="Orientation.Horizontal" Wrap="true" Style="gap: 0.4rem;">
                                <FluentBadge BackgroundColor="var(--accent-fill-rest)" Color="white">
                                    <FluentIcon Value="@(new Icons.Regular.Size12.Location())" /> @wishlist.Places.Count places
                                </FluentBadge>
                                @if (wishlist.SharedWith.Count > 0)
                                {
                                    <FluentBadge BackgroundColor="var(--neutral-layer-3)">
                                        <FluentIcon Value="@(new Icons.Regular.Size12.People())" /> @wishlist.SharedWith.Count shared
                                    </FluentBadge>
                                }
                            </FluentStack>
                            <FluentLabel Style="font-size: 0.8em; color: var(--neutral-foreground-hint);">
                                Created: @wishlist.CreatedAt.ToString("yyyy-MM-dd")
                            </FluentLabel>
                            <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation" />
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size16.Eye())" OnClick="@(() => ViewWishlist(wishlist.Id))">
                                    View
                                </FluentButton>
                                <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Share())" OnClick="@(() => ShowShareDialog(wishlist))">
                                    Share
                                </FluentButton>
                                <FluentSpacer />
                                <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Delete())" OnClick="@(() => DeleteWishlist(wishlist.Id))">
                                    Delete
                                </FluentButton>
                            </FluentStack>
                        </FluentStack>
                    </FluentCard>
                </FluentGridItem>
            }
        </FluentGrid>
    }

    <h2>Shared With Me</h2>
    @if (!sharedWishlists.Any())
    {
        <FluentCard class="wishlist-empty-card">
            <FluentStack HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" Style="padding: 2rem;">
                <FluentIcon Value="@(new Icons.Regular.Size48.People())" Color="Color.Neutral" />
                <FluentLabel Typo="Typography.Body">No wishlists have been shared with you yet.</FluentLabel>
            </FluentStack>
        </FluentCard>
    }
    else
    {
        <FluentGrid Spacing="3" Justify="JustifyContent.FlexStart">
            @foreach (var wishlist in sharedWishlists)
            {
                <FluentGridItem xs="12" sm="6" md="4" lg="3">
                    <FluentCard class="wishlist-card wishlist-card--shared">
                        <FluentStack Orientation="Orientation.Vertical" Style="height: 100%;">
                            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                                <FluentIcon Value="@(new Icons.Regular.Size24.HeartCircle())" Color="Color.Accent" />
                                <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold" Style="margin-left: 0.5rem; flex: 1;">@wishlist.Name</FluentLabel>
                            </FluentStack>
                            <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation" />
                            @if (!string.IsNullOrEmpty(wishlist.Description))
                            {
                                <FluentLabel Typo="Typography.Body" Style="flex: 1;">@wishlist.Description</FluentLabel>
                            }
                            else
                            {
                                <FluentLabel Typo="Typography.Body" Style="flex: 1; color: var(--neutral-foreground-hint); font-style: italic;">No description</FluentLabel>
                            }
                            <FluentSpacer />
                            <FluentStack Orientation="Orientation.Horizontal" Wrap="true" Style="gap: 0.4rem;">
                                <FluentBadge BackgroundColor="var(--accent-fill-rest)" Color="white">
                                    <FluentIcon Value="@(new Icons.Regular.Size12.Location())" /> @wishlist.Places.Count places
                                </FluentBadge>
                                <FluentBadge BackgroundColor="var(--neutral-layer-3)">
                                    <FluentIcon Value="@(new Icons.Regular.Size12.Person())" /> @wishlist.Owner?.Email
                                </FluentBadge>
                            </FluentStack>
                            <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation" />
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size16.Eye())" OnClick="@(() => ViewWishlist(wishlist.Id))">
                                    View
                                </FluentButton>
                            </FluentStack>
                        </FluentStack>
                    </FluentCard>
                </FluentGridItem>
            }
        </FluentGrid>
    }
}

<FluentDialog @ref="createDialog" Hidden="@hideCreateDialog" Modal="true">
    <h3>Create New Wishlist</h3>
    <EditForm Model="@newWishlist" OnValidSubmit="@CreateWishlist">
        <FluentStack Orientation="Orientation.Vertical">
            <FluentTextField @bind-Value="newWishlist.Name" Label="Name" Required="true" Style="width: 100%;" />
            <FluentTextArea @bind-Value="newWishlist.Description" Label="Description" Style="width: 100%;" />
            <FluentStack Orientation="Orientation.Horizontal">
                <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent">Create</FluentButton>
                <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => hideCreateDialog = true)">Cancel</FluentButton>
            </FluentStack>
        </FluentStack>
    </EditForm>
</FluentDialog>

<FluentDialog @ref="shareDialog" Hidden="@(!showShareDialog)" Modal="true">
    <h3>Share Wishlist: @selectedWishlist?.Name</h3>
    <FluentStack Orientation="Orientation.Vertical">
        <FluentTextField @bind-Value="shareEmail" Label="Email address to share with" Style="width: 100%;" />
        <FluentStack Orientation="Orientation.Horizontal">
            <FluentButton Appearance="Appearance.Accent" OnClick="@ShareWishlist">Share</FluentButton>
            <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => hideCreateDialog = true)">Cancel</FluentButton>
        </FluentStack>
    </FluentStack>
</FluentDialog>

@code {
    private List<Wishlist>? ownedWishlists;
    private List<Wishlist>? sharedWishlists;
    private string? currentUserId;
    
    private FluentDialog? createDialog;
    private FluentDialog? shareDialog;
    private bool hideCreateDialog = true;
    private bool showShareDialog;
    private Wishlist newWishlist = new();
    private Wishlist? selectedWishlist;
    private string shareEmail = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await UserService.GetCurrentUserIdAsync();

        if (currentUserId != null)
        {
            await LoadWishlists();
        }
    }

    private async Task LoadWishlists()
    {
        if (currentUserId != null)
        {
            ownedWishlists = await WishlistRepository.GetAllByUserAsync(currentUserId);
            sharedWishlists = await WishlistRepository.GetSharedWithUserAsync(currentUserId);
        }
    }

    private void ShowCreateDialog()
    {
        newWishlist = new Wishlist();
        hideCreateDialog = false;
    }

    private async Task CreateWishlist()
    {
        if (currentUserId != null)
        {
            newWishlist.OwnerId = currentUserId;
            await WishlistRepository.AddAsync(newWishlist);
            await LoadWishlists();
            hideCreateDialog = true;
        }
    }

    private void ShowShareDialog(Wishlist wishlist)
    {
        selectedWishlist = wishlist;
        shareEmail = string.Empty;
        showShareDialog = true;
    }

    private async Task ShareWishlist()
    {
        if (selectedWishlist == null || string.IsNullOrWhiteSpace(shareEmail))
        {
            return;
        }

        var userToShareWith = await UserService.GetUserByEmailAsync(shareEmail);
        if (userToShareWith != null)
        {
            await WishlistRepository.ShareWithUserAsync(selectedWishlist.Id, userToShareWith.Id);
            await LoadWishlists();
        }
        
        showShareDialog = false;
    }

    private async Task DeleteWishlist(string id)
    {
        await WishlistRepository.DeleteAsync(id);
        await LoadWishlists();
    }

    private void ViewWishlist(string id)
    {
        NavigationManager.NavigateTo($"/wishlists/{id}");
    }
}
