@using TripPlanner.Web.Models
<FluentGrid Spacing="3" Justify="JustifyContent.FlexStart">
    @foreach (var place in Places)
    {
        <FluentGridItem xs="12" md="6" lg="3" xl="2" xxl="2">
            <FluentCard Style="@GetCardStyle(place)">
                <FluentStack Orientation="Orientation.Vertical" Style="height:100%">
                    <FluentStack Orientation="Orientation.Horizontal">
                        <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">@place.Name</FluentLabel>
                        @if (place.HasGpxTrack)
                        {
                            <FluentSpacer />
                            <FluentBadge Appearance="Appearance.Accent">GPX</FluentBadge>
                        }
                    </FluentStack>
                    <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation" />
                            
                    <FluentLabel Typo="Typography.Body">@place.Description</FluentLabel>
                            
                    <FluentSpacer />
                    <FluentStack Orientation="Orientation.Horizontal" Wrap="true">
                        <FluentBadge BackgroundColor="var(--neutral-layer-3)">@place.Category</FluentBadge>
                        @if (place.Wishlist is not null)
                        {
                            <FluentBadge BackgroundColor="var(--neutral-layer-3)">@place.Wishlist.Name</FluentBadge>
                        }
                    </FluentStack>
                            
                    @if (place.Tags.Any())
                    {
                        <FluentStack Orientation="Orientation.Horizontal" Wrap="true">
                            @foreach (var tag in place.Tags)
                            {
                                <FluentBadge BackgroundColor="var(--accent-fill-rest)">@tag</FluentBadge>
                            }
                        </FluentStack>
                    }
                            
                    <FluentLabel Style="font-size: 0.875em;">
                        <FluentIcon Icon="Icons.Regular.Size16.Location" />
                        @place.Latitude.ToString("F4"), @place.Longitude.ToString("F4")
                    </FluentLabel>
                            
                    <FluentDivider Style="width: 100%;" Role="DividerRole.Presentation" />
                            
                    <FluentStack Orientation="Orientation.Horizontal">
                        @if (OnEditPlace.HasDelegate)
                        {
                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Edit())" OnClick="@(() => OnEditPlace.InvokeAsync(place))">
                                Edit
                            </FluentButton>
                        }
                        <FluentSpacer />
                        @if (OnDeletePlace.HasDelegate)
                        {
                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Delete())" OnClick="@(() => OnDeletePlace.InvokeAsync(place.Id))">
                                Delete
                            </FluentButton>
                        }
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
    }
</FluentGrid>


@code {
    [Parameter, EditorRequired]
    public IEnumerable<Place> Places { get; set; } = default!;

    [Parameter]
    public EventCallback<Place> OnEditPlace { get; set; }

    [Parameter]
    public EventCallback<string> OnDeletePlace { get; set; }

    private Dictionary<string, string> _cardStyleCache = new();


    protected override void OnParametersSet()
    {
        _cardStyleCache.Clear();
    }


    private string GetCardStyle(Place place)
    {
        if (place.ImageData != null && place.ImageContentType != null
            && System.Text.RegularExpressions.Regex.IsMatch(place.ImageContentType, @"^image/[a-zA-Z0-9\-\+\.]+$"))
        {
            if (!_cardStyleCache.TryGetValue(place.Id, out var style))
            {
                var base64 = Convert.ToBase64String(place.ImageData);
                style = $"height: 100%; background-image: linear-gradient(rgba(255,255,255,0.82), rgba(255,255,255,0.82)), url('data:{place.ImageContentType};base64,{base64}'); background-size: cover; background-position: center;";
                _cardStyleCache[place.Id] = style;
            }
            return style;
        }
        return "height: 100%;";
    }

}