@using TripPlanner.Web.Models
@using TripPlanner.Web.Services

@inject UserService UserService

<FluentGrid Spacing="3" Justify="JustifyContent.FlexStart">
    @foreach (var place in Places)
    {
        <FluentGridItem xs="12" md="6" lg="3" xl="2" xxl="2">
            <div class="place-card" style="@("border-top-color: " + GetCategoryColor(place.Category))">
                <div class="place-card-image-header">
                    @if (HasValidImage(place))
                    {
                        <img src="@GetImageSrc(place)" alt="@place.Name" />
                    }
                    else
                    {
                        <div class="place-card-placeholder @GetCategoryClass(place.Category)">
                            <FluentIcon Value="@GetCategoryIcon(place.Category)" Width="40px" Color="Color.Fill" />
                        </div>
                    }
                    @if (place.HasGpxTrack)
                    {
                        <span class="place-card-gpx-badge">
                            <FluentBadge Appearance="Appearance.Accent">GPX</FluentBadge>
                        </span>
                    }
                    @if (!string.IsNullOrWhiteSpace(place.Notes))
                    {
                        <span class="place-card-notes-badge">
                            <FluentBadge BackgroundColor="var(--neutral-layer-4)"><FluentIcon Value="@(new Icons.Regular.Size20.NoteEdit())" Width="12px" /> Notes</FluentBadge>
                        </span>
                    }
                </div>

                <div class="place-card-body">
                    <div class="place-card-title">
                        <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">@place.Name</FluentLabel>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(place.Description))
                    {
                        <FluentLabel Typo="Typography.Body" Class="place-card-description">@place.Description</FluentLabel>
                    }

                    <div class="place-card-badges">
                        <FluentBadge BackgroundColor="@GetCategoryColor(place.Category)" Color="white">@place.Category</FluentBadge>
                        @if (place.Wishlist is not null)
                        {
                            <FluentBadge BackgroundColor="var(--neutral-layer-3)">@place.Wishlist.Name</FluentBadge>
                        }
                    </div>

                    @if (place.Tags.Any())
                    {
                        <div class="place-card-tags">
                            @foreach (var tag in place.Tags)
                            {
                                <FluentBadge BackgroundColor="var(--accent-fill-rest)" Color="white">@tag</FluentBadge>
                            }
                        </div>
                    }

                    <div class="place-card-location">
                        <FluentIcon Icon="Icons.Regular.Size12.Location" />
                        <span>@place.Latitude.ToString("F4"), @place.Longitude.ToString("F4")</span>
                    </div>
                </div>

                @if (CanShowPlaceActions(place))
                {
                    <hr class="place-card-divider" />
                    <div class="place-card-footer">
                        @if (OnNotesPlace.HasDelegate)
                        {
                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size20.NoteEdit())" OnClick="@(() => OnNotesPlace.InvokeAsync(place))">
                                Notes
                            </FluentButton>
                        }
                        @if (OnEditPlace.HasDelegate)
                        {
                            <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Edit())" OnClick="@(() => OnEditPlace.InvokeAsync(place))">
                                Edit
                            </FluentButton>
                        }
                        <FluentSpacer />
                        @if (OnDeletePlace.HasDelegate)
                        {
                            <FluentButton Appearance="Appearance.Lightweight" Color="var(--error)" IconStart="@(new Icons.Regular.Size16.Delete().WithColor(Color.Error))" OnClick="@(() => OnDeletePlace.InvokeAsync(place.Id))">
                                Delete
                            </FluentButton>
                        }
                    </div>
                }
            </div>
        </FluentGridItem>
    }
</FluentGrid>


@code {
    [Parameter, EditorRequired]
    public IEnumerable<Place> Places { get; set; } = default!;

    [Parameter, EditorRequired]
    public bool CanEdit { get; set; } = false;

    [Parameter]
    public EventCallback<Place> OnEditPlace { get; set; }

    [Parameter]
    public EventCallback<Place> OnNotesPlace { get; set; }

    [Parameter]
    public EventCallback<string> OnDeletePlace { get; set; }

    private Dictionary<string, string> _imageSrcCache = new();

    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await UserService.GetCurrentUserIdAsync();
    }

    protected override void OnParametersSet()
    {
        _imageSrcCache.Clear();
    }

    private bool HasValidImage(Place place) =>
        place.ImageData != null && place.ImageContentType != null &&
        System.Text.RegularExpressions.Regex.IsMatch(place.ImageContentType, @"^image/[a-zA-Z0-9\-\+\.]+$");

    private bool CanShowPlaceActions(Place place) =>
        CanEdit &&
        place.Wishlist is not null &&
        place.Wishlist.SharedWith.Any(sw => sw.Level <= ShareLevel.Editor && sw.UserId == currentUserId) &&
        (OnEditPlace.HasDelegate || OnDeletePlace.HasDelegate || OnNotesPlace.HasDelegate);

    private string GetImageSrc(Place place)
    {
        if (!_imageSrcCache.TryGetValue(place.Id, out var src))
        {
            src = $"data:{place.ImageContentType};base64,{Convert.ToBase64String(place.ImageData!)}";
            _imageSrcCache[place.Id] = src;
        }
        return src;
    }

    private string GetCategoryClass(PlaceCategory category) => category switch
    {
        PlaceCategory.Viewpoint => "place-cat-viewpoint",
        PlaceCategory.Museum => "place-cat-museum",
        PlaceCategory.Restaurant => "place-cat-restaurant",
        PlaceCategory.Nature => "place-cat-nature",
        PlaceCategory.Activity => "place-cat-activity",
        PlaceCategory.Accommodation => "place-cat-accommodation",
        PlaceCategory.Shopping => "place-cat-shopping",
        PlaceCategory.Entertainment => "place-cat-entertainment",
        _ => "place-cat-other",
    };

    private string GetCategoryColor(PlaceCategory category) => category switch
    {
        PlaceCategory.Viewpoint => "#6a11cb",
        PlaceCategory.Museum => "#b06000",
        PlaceCategory.Restaurant => "#c0392b",
        PlaceCategory.Nature => "#1a7a32",
        PlaceCategory.Activity => "#0052cc",
        PlaceCategory.Accommodation => "#00695c",
        PlaceCategory.Shopping => "#ad1457",
        PlaceCategory.Entertainment => "#e65100",
        _ => "#616161",
    };

    private Icon GetCategoryIcon(PlaceCategory category) => category switch
    {
        PlaceCategory.Viewpoint => new Icons.Regular.Size32.Globe(),
        PlaceCategory.Museum => new Icons.Regular.Size32.Building(),
        PlaceCategory.Restaurant => new Icons.Regular.Size32.Food(),
        PlaceCategory.Nature => new Icons.Regular.Size32.LeafTwo(),
        PlaceCategory.Activity => new Icons.Regular.Size32.Run(),
        PlaceCategory.Accommodation => new Icons.Regular.Size32.BuildingHome(),
        PlaceCategory.Shopping => new Icons.Regular.Size32.ShoppingBag(),
        PlaceCategory.Entertainment => new Icons.Regular.Size32.StarEmphasis(),
        _ => new Icons.Regular.Size32.LocationArrow(),
    };


}